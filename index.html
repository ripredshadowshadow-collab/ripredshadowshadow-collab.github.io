<!DOCTYPE:html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Grid Game</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configure Tailwind to use Inter font -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'pixel-gray': '#e5e7eb',
                    }
                },
            },
        }
    </script>
    <style>
        /* CRITICAL: Ensure HTML and Body fill the viewport */
        html, body {
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
        }
        
        /* Basic body styling */
        body {
            font-family: 'Inter', 'sans-serif';
            background-color: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            overflow-y: auto;
            padding: 0;
        }
        
        /* 1. Full-screen Video Background Implementation */
        #background-video {
            position: fixed; 
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover; 
            z-index: 0; 
            background-color: #000; 
            filter: brightness(0.6) grayscale(0.1);
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            pointer-events: none;
        }
        
        /* Background fade effect - smooth visibility at edges */
        #background-video::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to bottom, rgba(0,0,0,0.2) 0%, transparent 15%, transparent 85%, rgba(0,0,0,0.3) 100%);
            z-index: 1;
            pointer-events: none;
        }

        /* 2. Main Content Container Styling for Readability */
        .main-menu-container {
            z-index: 10; 
            position: relative;
            background-color: rgba(255, 255, 255, 0.9); 
            backdrop-filter: blur(5px);
            margin: 3rem auto;
            
            /* CRITICAL FIX: Constrain height and allow internal scrolling */
            max-height: calc(100vh - 6rem); 
            overflow-y: auto; /* IMPORTANT: Enable internal vertical scrolling */
        }

        /* Hide pages by default */
        .page {
            display: none;
            transition: opacity 0.3s ease-in-out;
            opacity: 0;
        }
        /* Style for the currently visible page */
        .page-visible {
            display: block;
            opacity: 1;
        }
        /* Hide map selection view */
        #map-selection-view {
            display: none !important;
        }
        .duration-btn {
            @apply shadow-sm transition-all duration-150;
        }
        /* Hide scrollbar for Chrome, Safari and Opera */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        /* Hide scrollbar for IE, Edge and Firefox */
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        /* Utility for smooth view transitions within a page */
        .view-transition {
            transition: opacity 0.3s ease-in-out;
        }
        
        /* Styling for the car card selection to make it look professional */
        .car-card {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            background-color: #f7f7f7; 
        }
        .car-card:hover {
            transform: scale(1.02);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
        }
        
        /* Custom CSS for the Game Track Visuals (GRID GAME) */
        #game-track {
            position: relative;
            background-color: #1a1a1a; /* Dark road color */
            overflow: hidden;
            cursor: pointer; /* Indicate it is clickable */
            border-left: 10px solid #555;
            border-right: 10px solid #555;
            
            /* Add lane dividers for a visual grid effect */
            background-image: linear-gradient(to bottom, #444 2px, transparent 2px);
            background-size: 100% 20%; /* 5 lanes total (100% / 5 = 20%) */
        }
        
        /* Style for the car (fixed X position, dynamic Y position) */
        #game-car {
            transition: top 0.15s ease-in-out; /* Smooth vertical lane change */
            /* Add a slight Z-index so it always overlaps traps */
            z-index: 15; 
            /* Car needs to be wider than tall now that it's facing right */
            width: 70px;
            height: 45px; 
        }
        
        /* Style for the traps (dynamic X and Y position) */
        .trap {
            position: absolute;
            width: 20%; /* Same width as the car lane */
            height: 20%; /* Same height as a lane */
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            transition: left 0.1s linear, opacity 0.1s linear; /* Smooth trap movement */
            pointer-events: none; /* Make sure clicks pass through traps to the track */
            z-index: 10;
        }
        
        /* Style for game over message */
        #game-over-message {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(220, 38, 38, 0.9);
            color: white;
            z-index: 20;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        /* Mobile Touch Controls */
        .mobile-controls {
            display: none;
            gap: 16px;
            justify-content: center;
            align-items: center;
            padding: 16px 0;
        }
        
        @media (max-width: 768px), (hover: none) and (pointer: coarse) {
            .mobile-controls {
                display: flex;
            }
            .desktop-controls-hint {
                display: none;
            }
        }
        
        .touch-btn {
            width: 80px;
            height: 80px;
            border-radius: 16px;
            border: none;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
            transition: transform 0.1s ease, box-shadow 0.1s ease;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            touch-action: manipulation;
        }
        
        .touch-btn:active {
            transform: scale(0.92);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }
        
        .touch-btn-up {
            background: linear-gradient(135deg, #3B82F6, #1D4ED8);
            color: white;
        }
        
        .touch-btn-down {
            background: linear-gradient(135deg, #EF4444, #B91C1C);
            color: white;
        }
        
        .touch-btn-step {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: linear-gradient(135deg, #22C55E, #15803D);
            color: white;
            font-size: 18px;
            font-weight: bold;
        }
        
        /* Compact buttons for very small screens */
        @media (max-width: 380px) {
            .touch-btn {
                width: 64px;
                height: 64px;
                font-size: 22px;
            }
            .touch-btn-step {
                width: 80px;
                height: 80px;
                font-size: 14px;
            }
        }

        /* Sound Toggle Button */
        .sound-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.9);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            z-index: 100;
            transition: all 0.2s ease;
            -webkit-tap-highlight-color: transparent;
        }
        
        .sound-toggle:hover {
            transform: scale(1.1);
            background: rgba(255, 255, 255, 1);
        }
        
        .sound-toggle:active {
            transform: scale(0.95);
        }
        
        .sound-toggle svg {
            width: 24px;
            height: 24px;
            fill: #1f2937;
        }
        
        .sound-toggle.muted svg.sound-on,
        .sound-toggle:not(.muted) svg.sound-off {
            display: none;
        }
        
        .sound-toggle.muted svg.sound-off,
        .sound-toggle:not(.muted) svg.sound-on {
            display: block;
        }

        /* Practice Mode Video Background */
        .practice-background-video {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: 0;
            background-color: #000;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            pointer-events: none;
        }

        /* Practice Sound Toggle Button */
        .practice-sound-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.9);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            z-index: 100;
            transition: all 0.2s ease;
            -webkit-tap-highlight-color: transparent;
            opacity: 0;
            pointer-events: none;
        }

        .practice-sound-toggle.visible {
            opacity: 1;
            pointer-events: auto;
        }

        .practice-sound-toggle:hover {
            transform: scale(1.1);
            background: rgba(255, 255, 255, 1);
        }

        .practice-sound-toggle:active {
            transform: scale(0.95);
        }

        .practice-sound-toggle svg {
            width: 24px;
            height: 24px;
            fill: #1f2937;
        }

        .practice-sound-toggle.muted svg.sound-on,
        .practice-sound-toggle:not(.muted) svg.sound-off {
            display: none;
        }

        .practice-sound-toggle.muted svg.sound-off,
        .practice-sound-toggle:not(.muted) svg.sound-on {
            display: block;
        }

        /* Mobile HUD Styles (Consolidated from mobile.css) */
        .mobile-only { display: none; }
        @media (max-width: 900px), (hover: none) {
            .mobile-only { display: block; position: absolute; inset: 0; pointer-events: none; z-index: 9999; }
            #mobile-hud { pointer-events: auto; display:flex; flex-direction:column; justify-content:space-between; height:100%; padding:12px; box-sizing:border-box; }
            .hud-top { display:flex; justify-content:space-between; gap:8px; color:#fff; font-weight:600; text-shadow:0 1px 2px rgba(0,0,0,.7); }
            .hud-item { background: rgba(0,0,0,0.36); padding:6px 10px; border-radius:8px; font-size:14px; min-width:64px; text-align:center; }
            .touch-controls { display:flex; justify-content:space-between; align-items:flex-end; gap:12px; padding-bottom:8px; }
            .tc-btn { width:72px; height:72px; border-radius:12px; background:linear-gradient(180deg, rgba(255,255,255,0.06), rgba(0,0,0,0.35)); color:#fff; border:none; font-size:24px; box-shadow:0 4px 10px rgba(0,0,0,0.35); -webkit-tap-highlight-color: transparent; }
            .tc-btn:active, .tc-btn.active { background:rgba(255,255,255,0.12); transform:translateY(1px); }
            .tc-middle { display:flex; flex-direction:column; gap:8px; align-items:center; }
            @media (max-width:420px) {
                .tc-btn { width:60px; height:60px; font-size:20px; }
                .hud-item { font-size:13px; padding:5px 8px; }
            }
            #mobile-hud.playing .hud-top { opacity: 0.88; transition: opacity .2s; }
        }

    </style>
</head>
<body class="min-h-screen flex items-center justify-center py-12">

    <!-- Menu Video Background Element (Autoplay, Loop, and Muted) -->
    <video autoplay muted loop playsinline id="background-video">
        <source src="background-video.mp4" type="video/mp4">
        Your browser does not support the video tag.
    </video>

    <!-- Practice Mode Video Background Element -->
    <video muted loop playsinline id="practice-video" class="practice-background-video">
        <source src="practice-video.mp4" type="video/mp4">
        Your browser does not support the video tag.
    </video>

    <!-- Menu Sound Toggle Button -->
    <button id="sound-toggle" class="sound-toggle muted" aria-label="Unmute Sound">
        <svg class="sound-on" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>
        </svg>
        <svg class="sound-off" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z"/>
        </svg>
    </button>

    <!-- Practice Mode Sound Toggle Button -->
    <button id="practice-sound-toggle" class="practice-sound-toggle muted" aria-label="Unmute Sound">
        <svg class="sound-on" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>
        </svg>
        <svg class="sound-off" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z"/>
        </svg>
    </button>

    <!-- Engine Start Sound (Plays until car starts moving) -->
    <audio id="engine-start-sound" preload="auto" loop>
        <source src="attached_assets/engine start_1764391712357.mp3" type="audio/mpeg">
    </audio>

    <!-- Car-Specific Acceleration Sounds -->
    <audio id="toyota-acc-sound" preload="auto">
        <source src="attached_assets/toyota acc_1764391712357.mp3" type="audio/mpeg">
    </audio>
    <audio id="subaru-acc-sound" preload="auto">
        <source src="attached_assets/subaru acc_1764391712357.mp3" type="audio/mpeg">
    </audio>
    <audio id="nissan-acc-sound" preload="auto">
        <source src="attached_assets/nissan acc_1764391712357.mp3" type="audio/mpeg">
    </audio>

    <!-- Supra Ratatatata Sound (Plays when car stops after movement) -->
    <audio id="supra-ratatatata-sound" preload="auto">
        <source src="attached_assets/supra_ratatatata_1764391712357.mp3" type="audio/mpeg">
    </audio>

    <!-- Main Menu Content Container -->
    <div class="w-full max-w-sm mx-auto p-4 main-menu-container rounded-xl shadow-2xl">
        
        <!-- Welcome Race -->
        <h1 id="main-title" class="text-3xl font-bold text-center text-gray-800 mb-6 transition-opacity duration-300">Main Menu</h1>
        
        <!-- Navigation Menu (Always visible for main selection) -->
        <nav id="menu-nav" class="bg-white rounded-lg shadow-xl mb-8 transition-opacity duration-300">
            <ul class="flex flex-col">
                <!-- Practice Option -->
                <li>
                    <a href="javascript:void(0)" onclick="showPage('practice')"
                       class="flex items-center justify-center w-full px-6 py-4 text-lg font-medium text-white bg-red-600 rounded-t-lg hover:bg-red-700 transition-colors duration-200">
                        <span class="text-xl mr-3" role="img" aria-label="Race Flag">üèÅ</span>
                        Practice
                    </a>
                </li>
                
                <!-- Separator -->
                <li class="border-t border-gray-200"></li>

                <!-- CPS Tester Option -->
                <li>
                    <a href="javascript:void(0)" onclick="showPage('cps-tester')"
                       class="flex items-center justify-center w-full px-6 py-4 text-lg font-medium text-red-600 hover:bg-red-50 transition-colors duration-200">
                        <svg class="w-5 h-5 mr-3 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 15l-2 5L9 9l11 4-5 2zm0 0l5 5M7.188 2.239l.777 2.897M5.136 7.965l-2.898-.777M13.95 4.05l-2.122 2.122m-5.657 5.656l-2.12 2.122"></path></svg>
                        CPS Tester
                    </a>
                </li>
                
                <!-- Separator -->
                <li class="border-t border-gray-200"></li>

                <!-- Reaction Tester Option -->
                <li>
                    <a href="javascript:void(0)" onclick="showPage('reaction-tester')"
                       class="flex items-center justify-center w-full px-6 py-4 text-lg font-medium text-yellow-600 hover:bg-yellow-50 transition-colors duration-200">
                        <svg class="w-5 h-5 mr-3 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                        Reaction Tester
                    </a>
                </li>
                
                <!-- Separator -->
                <li class="border-t border-gray-200"></li>

                <!-- Online Mode Option (NEW) -->
                <li>
                    <a href="javascript:void(0)" onclick="showPage('online-mode')"
                       class="flex items-center justify-center w-full px-6 py-4 text-lg font-medium text-white bg-green-600 rounded-b-lg hover:bg-green-700 transition-colors duration-200">
                        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                        Online Mode
                    </a>
                </li>
            </ul>
        </nav>

        <!-- Dynamic Content Pages -->
        <div id="pages-container" class="mt-8">

            <!-- Practice Page Content (Handles four views: Car Select, Car Details, Map Selection, Driving View) -->
            <div id="practice" class="page bg-white rounded-lg shadow-xl p-6">
                
                <!-- 1. Car Selection View (Default) -->
                <div id="car-select-view" class="view-transition">
                    <h2 class="text-2xl font-bold mb-2 text-gray-800 text-center">Select Your Car</h2>
                    <p class="text-gray-500 mb-6 text-center text-sm">Swipe to choose your ride and see details.</p>
                    
                    <!-- Carousel Container -->
                    <div class="relative w-full mb-6">
                        
                        <!-- Left Arrow -->
                        <button onclick="scrollCarousel(-1)" class="absolute left-0 top-1/2 -translate-y-1/2 z-10 bg-white/80 rounded-full p-2 shadow-md hover:bg-white text-gray-600">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                        </button>

                        <!-- Scrollable Area -->
                        <div id="car-carousel" class="flex overflow-x-auto snap-x snap-mandatory no-scrollbar space-x-4 pb-4">
                            
                            <!-- Car 1: AE86 (Image) -->
                            <div class="snap-center shrink-0 w-full flex flex-col items-center">
                                <div onclick="selectCar('AE86')" class="car-card w-full bg-gray-50 rounded-xl border-2 border-gray-200 p-6 flex flex-col items-center cursor-pointer hover:border-gray-800 transition-all active:scale-[0.98]">
                                    <img src="https://placehold.co/400x200/FACC15/1F2937?text=AE86+Trueno"
                                         alt="Toyota AE86 Trueno" 
                                         class="w-full h-32 mb-4 object-contain rounded-lg shadow-md border border-gray-300"
                                         onerror="this.onerror=null; this.src='https://placehold.co/400x200/e2e8f0/1e293b?text=AE86';">
                                    <h3 class="font-bold text-gray-800 text-xl">Toyota AE86</h3>
                                    <p class="text-sm text-gray-500">Drift Legend</p>
                                </div>
                            </div>

                            <!-- Car 2: GTR (Image) -->
                            <div class="snap-center shrink-0 w-full flex flex-col items-center">
                                <div onclick="selectCar('GTR')" class="car-card w-full bg-gray-50 rounded-xl border-2 border-gray-200 p-6 flex flex-col items-center cursor-pointer hover:border-blue-600 transition-all active:scale-[0.98]">
                                    <img src="https://placehold.co/400x200/2563EB/ffffff?text=Skyline+GT-R"
                                         alt="Nissan Skyline GT-R R34" 
                                         class="w-full h-32 mb-4 object-contain rounded-lg shadow-md border border-gray-300"
                                         onerror="this.onerror=null; this.src='https://placehold.co/400x200/bfdbfe/1e3a8a?text=Skyline+GTR';">
                                    <h3 class="font-bold text-gray-800 text-xl">Nissan Skyline</h3>
                                    <p class="text-sm text-gray-500">Godzilla</p>
                                </div>
                            </div>

                            <!-- Car 3: BRZ (Image) -->
                            <div class="snap-center shrink-0 w-full flex flex-col items-center">
                                <div onclick="selectCar('BRZ')" class="car-card w-full bg-gray-50 rounded-xl border-2 border-gray-200 p-6 flex flex-col items-center cursor-pointer hover:border-indigo-600 transition-all active:scale-[0.98]">
                                    <img src="https://placehold.co/400x200/4F46E5/ffffff?text=Subaru+BRZ"
                                         alt="Subaru BRZ Placeholder" 
                                         class="w-full h-32 mb-4 object-contain rounded-lg shadow-md border border-gray-300"
                                         onerror="this.onerror=null; this.src='https://placehold.co/400x200/bfdbfe/1e3a8a?text=BRZ';">
                                    <h3 class="font-bold text-gray-800 text-xl">Subaru BRZ</h3>
                                    <p class="text-sm text-gray-500">Agile Handler</p>
                                </div>
                            </div>

                        </div>

                        <!-- Right Arrow -->
                        <button onclick="scrollCarousel(1)" class="absolute right-0 top-1/2 -translate-y-1/2 z-10 bg-white/80 rounded-full p-2 shadow-md hover:bg-white text-gray-600">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                        </button>
                        
                        <!-- Indicators -->
                        <div class="flex justify-center space-x-2 mt-2">
                            <div class="w-2 h-2 rounded-full bg-gray-300 indicator"></div>
                            <div class="w-2 h-2 rounded-full bg-gray-300 indicator"></div>
                            <div class="w-2 h-2 rounded-full bg-gray-300 indicator"></div>
                        </div>

                    </div>
                    
                    <!-- Back Button for main Practice view -->
                    <button onclick="showPage('menu')" class="mt-6 w-full bg-gray-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-gray-600 transition-colors shadow-md">
                        ‚Üê Back to Menu
                    </button>
                </div>
                

                <!-- 3. Map Selection View -->
                <div id="map-selection-view" class="view-transition hidden">
                    <h2 class="text-3xl font-extrabold text-gray-900 text-center mb-6">Choose Practice Mode</h2>
                    
                    <!-- Random Map Option (Now starts the game) -->
                    <button onclick="startRace('random')" class="w-full mb-4 p-4 bg-green-600 text-white font-bold text-xl rounded-lg hover:bg-green-700 transition-colors shadow-lg flex items-center justify-center">
                        <span class="mr-3 text-2xl" role="img" aria-label="Dice">üé≤</span> Start Practice
                    </button>

                    <!-- Maps Option (Placeholder) -->
                    <button onclick="showMapsList()" class="w-full mb-6 p-4 bg-blue-600 text-white font-bold text-xl rounded-lg hover:bg-blue-700 transition-colors shadow-lg flex items-center justify-center">
                        <span class="mr-3 text-2xl" role="img" aria-label="Map">üó∫Ô∏è</span> Map Selection (Disabled)
                    </button>

                    <!-- Back Button -->
                    <button onclick="showCarSelectView()" class="w-full bg-gray-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-gray-600 transition-colors shadow-md">
                        ‚Üê Back to Car Selection
                    </button>
                </div>
                
                <!-- 4. Driving View (GRID GAME AREA) -->
                <div id="driving-view" class="view-transition hidden">
                    <h2 class="text-3xl font-extrabold text-red-600 text-center mb-4">Avoid Traps</h2>
                    
                    <!-- Desktop Controls Hint (hidden on mobile) -->
                    <p class="desktop-controls-hint text-center text-gray-600 mb-6 font-semibold text-lg">
                        <span class="text-blue-600">W</span> (Up/Step) | 
                        <span class="text-red-600">S</span> (Down/Step) |
                        <span class="text-yellow-600">CLICK/TOUCH</span> (Step Forward)
                    </p>

                    <!-- Game Container -->
                    <div id="game-track" class="w-full h-80 bg-gray-100 rounded-lg border-4 border-gray-800 relative overflow-hidden mb-4">
                        
                        <!-- Game Over Message -->
                        <div id="game-over-message" class="hidden">
                            <p class="text-6xl font-extrabold mb-4">CRASH!</p>
                            <p class="text-2xl font-semibold mb-6">Game Over</p>
                            <p class="text-xl font-medium mb-4">Final Score: <span id="final-game-score" class="font-extrabold">0</span> Grids</p>
                            <button onclick="CarGame.reset();" class="bg-white text-red-600 font-bold py-3 px-6 rounded-lg hover:bg-gray-100 transition-colors shadow-md">
                                Try Again
                            </button>
                        </div>
                        
                        <!-- Car Icon (Fixed on the left, moves vertically) -->
                        <div id="game-car" 
                             class="absolute left-1/4 top-1/2 -translate-y-1/2 flex items-center justify-center transition-all duration-75 ease-linear" 
                             style="transform: translateY(-50%);">
                            <!-- Selected Car SVG will be injected here -->
                        </div>
                        
                        <!-- Traps will be rendered here dynamically -->
                        <div id="trap-container">
                            <!-- Traps elements go here -->
                        </div>
                    </div>
                    
                    <!-- Mobile Touch Controls -->
                    <div class="mobile-controls">
                        <button id="btn-up" class="touch-btn touch-btn-up" aria-label="Move Up">
                            <span>W</span>
                        </button>
                        <button id="btn-step" class="touch-btn touch-btn-step" aria-label="Step Forward">
                            <span>GO!</span>
                        </button>
                        <button id="btn-down" class="touch-btn touch-btn-down" aria-label="Move Down">
                            <span>S</span>
                        </button>
                    </div>
                    
                    <!-- Score and Timer Display -->
                    <div class="p-4 bg-red-100 rounded-xl shadow-lg flex justify-between items-center border-b-4 border-red-400">
                        <div>
                            <p class="text-sm font-medium text-gray-500">Grids Safely Passed</p>
                        </div>
                        <p id="current-score-display" class="text-5xl font-extrabold text-red-700">0</p>
                    </div>
                    
                    <!-- Timer Display -->
                    <div class="mt-3 p-3 bg-blue-100 rounded-lg shadow-md flex justify-center items-center border-2 border-blue-300">
                        <p class="text-sm font-medium text-gray-600 mr-3">‚è±Ô∏è Time Elapsed:</p>
                        <p id="game-timer-display" class="text-3xl font-extrabold text-blue-600">0s</p>
                    </div>

                    <!-- Back Button -->
                    <button onclick="endRacePractice()" class="mt-6 w-full bg-gray-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-gray-600 transition-colors shadow-md">
                        ‚Üê End Game
                    </button>
                </div>
            </div>
            
            <!-- 1. CPS Tester Page Content (Unchanged) -->
            <div id="cps-tester" class="page bg-white rounded-lg shadow-2xl p-6">
                <h2 class="text-3xl font-extrabold mb-4 text-gray-800 text-center">CPS Tester</h2>
                <div class="flex justify-center space-x-2 mb-6" id="cps-duration-selector">
                    <button onclick="setCPSTime(1)" id="duration-1" class="duration-btn bg-gray-200 text-gray-700 py-2 px-4 rounded-lg font-medium hover:bg-gray-300 transition-colors">1s</button>
                    <button onclick="setCPSTime(5)" id="duration-5" class="duration-btn bg-indigo-600 text-white py-2 px-4 rounded-lg font-medium ring-2 ring-indigo-400 transition-colors">5s</button>
                    <button onclick="setCPSTime(10)" id="duration-10" class="duration-btn bg-gray-200 text-gray-700 py-2 px-4 rounded-lg font-medium hover:bg-gray-300 transition-colors">10s</button>
                </div>
                
                <div id="cps-test-area">
                    <div class="flex justify-between items-center mb-4 p-3 bg-red-50 rounded-lg border-b-4 border-red-500 shadow-inner">
                        <p class="text-lg font-medium text-red-500">Time: <span id="cps-timer" class="text-xl font-bold text-red-600">5.0</span>s</p>
                        <p class="text-lg font-medium text-red-500">Clicks: <span id="cps-click-count" class="text-xl font-bold text-red-600">0</span></p>
                    </div>

                    <div id="cps-message" class="text-center text-sm mb-4 text-gray-500">
                        Click the button below to start the <span id="current-duration-display">5</span>-second test!
                    </div>

                    <button id="click-area" 
                            class="w-full h-40 flex items-center justify-center text-3xl font-black text-white bg-gray-700 rounded-xl shadow-lg hover:shadow-xl transition-all duration-150 transform hover:scale-[1.01] cursor-pointer">
                        START
                    </button>
                </div>

                <div id="cps-results-summary" class="hidden text-center">
                    <div class="p-6 bg-red-50 rounded-xl border-2 border-red-200 mb-6 shadow-md">
                        
                        <p class="text-xl text-red-500 font-semibold mb-2">Your Score (Average CPS):</p>
                        <p id="final-cps-score" class="text-6xl font-extrabold text-red-600 mb-4">0.00</p>
                        
                        <p class="text-xl text-red-500 font-semibold mb-2">Speed (KMPH):</p>
                        <p id="final-kmph-score" class="text-4xl font-extrabold text-red-600 mb-4">0.00</p>
                        
                        <p class="text-base text-red-500">Total Clicks: <span id="final-total-clicks">0</span></p>
                        <p class="text-base text-red-500">Test Duration: <span id="final-test-duration">5</span> seconds</p>
                    </div>
                    
                    <button onclick="resetCPSTester()" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 transition-colors shadow-md mb-3">
                        Try Again
                    </button>
                </div>
                
                <button onclick="showPage('menu')" id="cps-back-button" class="mt-6 w-full bg-gray-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-gray-600 transition-colors shadow-md">
                    ‚Üê Back to Menu
                </button>
            </div>

            <!-- 2. Reaction Tester Page Content (Unchanged) -->
            <div id="reaction-tester" class="page bg-white rounded-lg shadow-xl p-6">
                <h2 class="text-3xl font-extrabold mb-4 text-red-600 text-center">Reaction Time Tester</h2>

                <div id="reaction-click-area" 
                     class="w-full h-80 flex items-center justify-center text-xl font-bold text-white rounded-xl shadow-lg transition-all duration-300 transform cursor-pointer select-none"
                     style="user-select: none;"
                >
                    <div id="reaction-status-text" class="text-center p-4">
                        <p class="text-2xl font-bold mb-2">Click anywhere to start.</p>
                        <p class="text-sm opacity-80">Wait for the screen to turn <span class="text-green-300 font-extrabold">GREEN</span>.</p>
                    </div>
                </div>

                <div id="reaction-result-display" class="hidden text-center mt-6">
                    <div class="p-6 bg-green-50 rounded-xl border-2 border-green-200 mb-6 shadow-md">
                        <p class="text-xl text-gray-700 font-semibold mb-2">Your Reaction Time:</p>
                        <p id="reaction-time-score" class="text-6xl font-extrabold text-green-600 mb-4">0 ms</p>
                        <p id="reaction-rank" class="text-2xl font-bold text-gray-800 mb-4"></p>
                        <p id="reaction-average-score" class="text-base text-gray-500">Average of 0 runs: 0 ms</p>
                    </div>
                    
                    <button onclick="startReactionWaiting()" class="w-full bg-green-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-600 transition-colors shadow-md mb-3">
                        Start New Test
                    </button>
                </div>
                
                <button onclick="showPage('menu')" class="mt-6 w-full bg-gray-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-gray-600 transition-colors shadow-md">
                    ‚Üê Back to Menu
                </button>
            </div>

            <!-- 3. Online Mode Page Content (NEW) -->
            <div id="online-mode" class="page bg-white rounded-lg shadow-xl p-6">
                
                <!-- Username Entry View -->
                <div id="online-username-view" class="view-transition">
                    <h2 class="text-2xl font-bold mb-2 text-gray-800 text-center">Online Mode</h2>
                    <p class="text-gray-500 mb-6 text-center text-sm">Race against other players online!</p>
                    
                    <div class="mb-6">
                        <label for="username-input" class="block text-sm font-medium text-gray-700 mb-2">Enter Your Username</label>
                        <input type="text" id="username-input" maxlength="16" placeholder="Your username..."
                               class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-green-500 focus:outline-none text-lg"
                               onkeypress="if(event.key==='Enter') OnlineGame.submitUsername()">
                    </div>
                    
                    <button onclick="OnlineGame.submitUsername()" 
                            class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 transition-colors shadow-md mb-4">
                        Continue
                    </button>
                    
                    <button onclick="showPage('menu')" class="w-full bg-gray-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-gray-600 transition-colors shadow-md">
                        ‚Üê Back to Menu
                    </button>
                </div>

                <!-- Host/Join Selection View -->
                <div id="online-selection-view" class="view-transition hidden">
                    <h2 class="text-2xl font-bold mb-2 text-gray-800 text-center">Welcome, <span id="display-username" class="text-green-600"></span>!</h2>
                    <p class="text-gray-500 mb-6 text-center text-sm">Choose how you want to race</p>
                    
                    <!-- Car Selection for Online -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Select Your Car</label>
                        <div class="grid grid-cols-3 gap-2">
                            <button onclick="OnlineGame.selectCar('AE86')" id="online-car-AE86"
                                    class="online-car-btn p-3 border-2 border-gray-300 rounded-lg hover:border-green-500 transition-all text-center">
                                <div class="text-2xl mb-1">üöó</div>
                                <div class="text-xs font-medium">AE86</div>
                            </button>
                            <button onclick="OnlineGame.selectCar('GTR')" id="online-car-GTR"
                                    class="online-car-btn p-3 border-2 border-gray-300 rounded-lg hover:border-green-500 transition-all text-center">
                                <div class="text-2xl mb-1">üèéÔ∏è</div>
                                <div class="text-xs font-medium">GT-R</div>
                            </button>
                            <button onclick="OnlineGame.selectCar('BRZ')" id="online-car-BRZ"
                                    class="online-car-btn p-3 border-2 border-gray-300 rounded-lg hover:border-green-500 transition-all text-center">
                                <div class="text-2xl mb-1">üöô</div>
                                <div class="text-xs font-medium">BRZ</div>
                            </button>
                        </div>
                    </div>
                    
                    <button onclick="OnlineGame.hostRace()" 
                            class="w-full bg-green-600 text-white font-bold py-4 px-4 rounded-lg hover:bg-green-700 transition-colors shadow-md mb-3 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                        Host Race
                    </button>
                    
                    <button onclick="OnlineGame.showJoinView()" 
                            class="w-full bg-blue-600 text-white font-bold py-4 px-4 rounded-lg hover:bg-blue-700 transition-colors shadow-md mb-4 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14"></path></svg>
                        Join Race
                    </button>
                    
                    <button onclick="OnlineGame.backToUsername()" class="w-full bg-gray-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-gray-600 transition-colors shadow-md">
                        ‚Üê Change Username
                    </button>
                </div>

                <!-- Join Race View -->
                <div id="online-join-view" class="view-transition hidden">
                    <h2 class="text-2xl font-bold mb-2 text-gray-800 text-center">Join Race</h2>
                    <p class="text-gray-500 mb-6 text-center text-sm">Enter the lobby code to join</p>
                    
                    <div class="mb-6">
                        <label for="lobby-code-input" class="block text-sm font-medium text-gray-700 mb-2">Lobby Code</label>
                        <input type="text" id="lobby-code-input" maxlength="6" placeholder="Enter 6-digit code..."
                               class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none text-lg text-center uppercase tracking-widest font-mono"
                               style="letter-spacing: 0.3em;"
                               onkeypress="if(event.key==='Enter') OnlineGame.joinRace()">
                    </div>
                    
                    <div id="join-error-message" class="hidden mb-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded-lg text-center text-sm"></div>
                    
                    <button onclick="OnlineGame.joinRace()" 
                            class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition-colors shadow-md mb-4">
                        Join Lobby
                    </button>
                    
                    <button onclick="OnlineGame.showSelectionView()" class="w-full bg-gray-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-gray-600 transition-colors shadow-md">
                        ‚Üê Back
                    </button>
                </div>

                <!-- Lobby View -->
                <div id="online-lobby-view" class="view-transition hidden">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-gray-800">Race Lobby</h2>
                        <div class="flex items-center bg-green-100 px-3 py-1 rounded-lg">
                            <span class="text-sm text-gray-600 mr-2">Code:</span>
                            <span id="lobby-code-display" class="font-mono font-bold text-green-700 text-lg tracking-wider"></span>
                            <button onclick="OnlineGame.copyLobbyCode()" class="ml-2 text-green-600 hover:text-green-800">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                            </button>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-sm font-medium text-gray-600">Players (<span id="player-count">0</span>/6)</span>
                            <span id="host-badge" class="hidden bg-yellow-100 text-yellow-800 text-xs font-medium px-2 py-1 rounded">You're Host</span>
                        </div>
                        <div id="player-list" class="bg-gray-50 rounded-lg p-3 min-h-[150px] max-h-[200px] overflow-y-auto">
                            <!-- Players will be listed here -->
                        </div>
                    </div>
                    
                    <div id="host-controls" class="hidden mb-4">
                        <button onclick="OnlineGame.startRace()" 
                                class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 transition-colors shadow-md flex items-center justify-center">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            Start Race
                        </button>
                    </div>
                    
                    <div id="waiting-message" class="mb-4 p-3 bg-blue-50 border border-blue-200 text-blue-700 rounded-lg text-center text-sm">
                        Waiting for host to start the race...
                    </div>
                    
                    <button onclick="OnlineGame.leaveLobby()" class="w-full bg-red-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-red-600 transition-colors shadow-md">
                        Leave Lobby
                    </button>
                </div>

                <!-- Countdown View -->
                <div id="online-countdown-view" class="view-transition hidden">
                    <div class="text-center py-12">
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">Race Starting!</h2>
                        <div id="countdown-number" class="text-9xl font-black text-green-600 animate-pulse">3</div>
                        <p class="text-gray-500 mt-4">Get ready to race!</p>
                    </div>
                </div>

                <!-- Online Racing View -->
                <div id="online-racing-view" class="view-transition hidden">
                    <div class="flex justify-between items-center mb-2">
                        <div class="bg-green-100 px-3 py-1 rounded-lg">
                            <span class="text-sm text-gray-600">Score: </span>
                            <span id="online-score-display" class="font-bold text-green-700">0</span>
                        </div>
                        <div class="bg-blue-100 px-3 py-1 rounded-lg">
                            <span class="text-sm text-gray-600">Time: </span>
                            <span id="online-timer-display" class="font-bold text-blue-700">0s</span>
                        </div>
                        <div class="bg-gray-100 px-3 py-1 rounded-lg">
                            <span class="text-sm text-gray-600">Alive: </span>
                            <span id="online-alive-display" class="font-bold text-gray-700">0</span>
                        </div>
                    </div>
                    
                    <!-- Other Players Status -->
                    <div id="online-players-status" class="flex flex-wrap gap-1 mb-2">
                        <!-- Player status indicators -->
                    </div>
                    
                    <!-- Game Track (Reused from practice) -->
                    <div id="online-game-track" class="relative w-full h-64 rounded-lg overflow-hidden mb-3" style="background-color: #1a1a1a; background-image: linear-gradient(to bottom, #444 2px, transparent 2px); background-size: 100% 20%; border-left: 10px solid #555; border-right: 10px solid #555;">
                        <div id="online-trap-container"></div>
                        <div id="online-game-car" class="absolute" style="left: 20%; transform: translate(-50%, -50%); width: 70px; height: 45px; z-index: 15;"></div>
                        <div id="online-game-over-message" class="absolute inset-0 bg-red-600/90 text-white z-20 hidden flex-col items-center justify-center text-center">
                            <h3 class="text-2xl font-bold mb-2">You Crashed!</h3>
                            <p id="online-crash-stats" class="text-lg"></p>
                            <p class="text-sm mt-2 opacity-80">Waiting for other players...</p>
                        </div>
                    </div>
                    
                    <!-- Mobile Controls for Online -->
                    <div class="mobile-controls flex gap-4 justify-center">
                        <button onmousedown="OnlineGame.moveUp()" ontouchstart="OnlineGame.moveUp(); event.preventDefault();" class="touch-btn touch-btn-up">W</button>
                        <button onmousedown="OnlineGame.stepForward()" ontouchstart="OnlineGame.stepForward(); event.preventDefault();" class="touch-btn touch-btn-step">GO!</button>
                        <button onmousedown="OnlineGame.moveDown()" ontouchstart="OnlineGame.moveDown(); event.preventDefault();" class="touch-btn touch-btn-down">S</button>
                    </div>
                    <p class="desktop-controls-hint text-center text-gray-500 text-xs mt-2">Use W/S keys to move, click track to step forward</p>
                </div>

                <!-- Leaderboard View -->
                <div id="online-leaderboard-view" class="view-transition hidden">
                    <h2 class="text-2xl font-bold mb-4 text-gray-800 text-center">Race Results</h2>
                    
                    <div id="leaderboard-container" class="mb-6">
                        <!-- Leaderboard entries will be inserted here -->
                    </div>
                    
                    <button onclick="OnlineGame.returnToLobby()" 
                            class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 transition-colors shadow-md mb-3">
                        Back to Lobby
                    </button>
                    
                    <button onclick="OnlineGame.leaveLobby()" class="w-full bg-gray-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-gray-600 transition-colors shadow-md">
                        Leave Race
                    </button>
                </div>

            </div>

        </div>
    </div>

    <script>
        // --- Global State ---
        let currentSelectedCarId = 'AE86'; // Default selected car

        // --- Car Data (Mock data with SVG definition) ---
        // Note: The SVG is slightly wider than tall (100x60 viewBox) to represent a horizontal, right-facing car.
        const carData = {
            'AE86': {
                name: 'Toyota AE86 Trueno',
                subtitle: 'The Tofu Delivery Legend',
                image: 'https://placehold.co/400x200/FACC15/1F2937?text=AE86+Trueno', 
                engine: '4A-GEU 1.6L I4',
                hp: '130 hp @ 6,600 rpm',
                torque: '115 lb-ft @ 5,200 rpm',
                drivetrain: 'FR (Front-Engine, Rear-Wheel Drive)',
                special: 'Famous for its lightweight chassis, excellent drift balance, and appearance in Initial D. A classic JDM icon.',
                svg: `
                    <svg viewBox="0 0 100 60" xmlns="http://www.w3.org/2000/svg" class="w-full h-full">
                        <defs>
                            <linearGradient id="ae86-body" x1="0%" y1="0%" x2="0%" y2="100%">
                                <stop offset="0%" style="stop-color:#FAFAFA;stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#E8E8E8;stop-opacity:1" />
                            </linearGradient>
                            <linearGradient id="ae86-hood" x1="0%" y1="0%" x2="0%" y2="100%">
                                <stop offset="0%" style="stop-color:#2A2A2A;stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#1A1A1A;stop-opacity:1" />
                            </linearGradient>
                        </defs>
                        
                        <!-- Ground shadows -->
                        <ellipse cx="22" cy="58" rx="7" ry="1.8" fill="#000" opacity="0.2"/>
                        <ellipse cx="78" cy="58" rx="7" ry="1.8" fill="#000" opacity="0.2"/>
                        
                        <!-- Main Body - Panda Trueno White -->
                        <path d="M 8 28 L 12 24 L 88 22 L 92 26 L 92 38 L 8 40 Z" fill="url(#ae86-body)" stroke="#CCC" stroke-width="0.5"/>
                        
                        <!-- Black Hood (Panda style) -->
                        <path d="M 75 22 L 92 24 L 92 32 L 75 30 Z" fill="url(#ae86-hood)" stroke="#111" stroke-width="0.3"/>
                        
                        <!-- Black Front Bumper -->
                        <path d="M 88 26 L 95 25 L 95 37 L 88 38 Z" fill="#1A1A1A" stroke="#111" stroke-width="0.3"/>
                        
                        <!-- Black Rear Bumper -->
                        <path d="M 5 27 L 10 26 L 10 40 L 5 39 Z" fill="#1A1A1A" stroke="#111" stroke-width="0.3"/>
                        
                        <!-- Body lower trim (black) -->
                        <path d="M 10 36 L 88 35 L 88 40 L 8 40 Z" fill="#222" opacity="0.6"/>
                        
                        <!-- Boxy Cabin/Roof (characteristic AE86 shape) -->
                        <path d="M 28 24 L 32 18 L 68 17 L 74 22 L 72 32 L 30 33 Z" fill="#1A1A2E" stroke="#0F0F1E" stroke-width="0.4"/>
                        
                        <!-- Front Windshield (steep angle - 80s style) -->
                        <path d="M 32 20 L 38 17 L 48 17 L 46 32 L 30 32 Z" fill="#6BB8E8" opacity="0.8" stroke="#444" stroke-width="0.3"/>
                        
                        <!-- Rear Windshield -->
                        <path d="M 52 18 L 68 18 L 72 24 L 70 32 L 54 32 Z" fill="#6BB8E8" opacity="0.6" stroke="#444" stroke-width="0.3"/>
                        
                        <!-- Side Windows -->
                        <path d="M 47 19 L 52 19 L 52 31 L 47 31 Z" fill="#6BB8E8" opacity="0.5"/>
                        
                        <!-- Pop-up Headlights (signature AE86 feature) -->
                        <rect x="83" y="18" width="5" height="4" fill="#222" rx="1"/>
                        <circle cx="85.5" cy="20" r="1.8" fill="#FFFDE7"/>
                        <circle cx="85.5" cy="20" r="1.2" fill="#FFF9C4" opacity="0.8"/>
                        <rect x="83" y="28" width="5" height="4" fill="#222" rx="1"/>
                        <circle cx="85.5" cy="30" r="1.8" fill="#FFFDE7"/>
                        <circle cx="85.5" cy="30" r="1.2" fill="#FFF9C4" opacity="0.8"/>
                        
                        <!-- Side mirrors (black) -->
                        <rect x="28" y="16" width="3" height="2" fill="#1A1A1A" rx="0.5"/>
                        
                        <!-- Door line -->
                        <line x1="50" y1="22" x2="50" y2="38" stroke="#AAA" stroke-width="0.4"/>
                        
                        <!-- Door handle -->
                        <rect x="42" y="28" width="3" height="1" fill="#888" rx="0.3"/>
                        <rect x="56" y="28" width="3" height="1" fill="#888" rx="0.3"/>
                        
                        <!-- Iconic AE86 side stripe (black) -->
                        <path d="M 12 30 L 75 28 L 75 32 L 12 34 Z" fill="#1A1A1A" opacity="0.15"/>
                        
                        <!-- Rear Taillights (horizontal bar style) -->
                        <rect x="6" y="28" width="3" height="5" fill="#CC0000" rx="0.5"/>
                        <rect x="6" y="35" width="3" height="3" fill="#FF4444" opacity="0.7" rx="0.3"/>
                        
                        <!-- Front Wheel (Watanabe-style 8-spoke) -->
                        <circle cx="22" cy="48" r="9" fill="#1A1A1A" stroke="#0D0D0D" stroke-width="0.5"/>
                        <circle cx="22" cy="48" r="7" fill="#2A2A2A"/>
                        <circle cx="22" cy="48" r="5" fill="#3A3A3A"/>
                        <circle cx="22" cy="48" r="2.5" fill="#C0C0C0"/>
                        <line x1="22" y1="43" x2="22" y2="53" stroke="#777" stroke-width="1"/>
                        <line x1="17" y1="48" x2="27" y2="48" stroke="#777" stroke-width="1"/>
                        <line x1="18.5" y1="44.5" x2="25.5" y2="51.5" stroke="#777" stroke-width="0.8"/>
                        <line x1="25.5" y1="44.5" x2="18.5" y2="51.5" stroke="#777" stroke-width="0.8"/>
                        
                        <!-- Rear Wheel -->
                        <circle cx="78" cy="48" r="9" fill="#1A1A1A" stroke="#0D0D0D" stroke-width="0.5"/>
                        <circle cx="78" cy="48" r="7" fill="#2A2A2A"/>
                        <circle cx="78" cy="48" r="5" fill="#3A3A3A"/>
                        <circle cx="78" cy="48" r="2.5" fill="#C0C0C0"/>
                        <line x1="78" y1="43" x2="78" y2="53" stroke="#777" stroke-width="1"/>
                        <line x1="73" y1="48" x2="83" y2="48" stroke="#777" stroke-width="1"/>
                        <line x1="74.5" y1="44.5" x2="81.5" y2="51.5" stroke="#777" stroke-width="0.8"/>
                        <line x1="81.5" y1="44.5" x2="74.5" y2="51.5" stroke="#777" stroke-width="0.8"/>
                        
                        <!-- Body shine -->
                        <ellipse cx="45" cy="26" rx="20" ry="4" fill="#FFF" opacity="0.15"/>
                    </svg>
                `
            },
            'GTR': {
                name: 'Nissan Skyline GT-R (R34)',
                subtitle: 'Godzilla: King of the Road',
                image: 'https://placehold.co/400x200/2563EB/ffffff?text=Skyline+GT-R', 
                engine: 'RB26DETT 2.6L I6 Twin-Turbo',
                hp: '280 hp (claimed) / ~330 hp (actual)',
                torque: '260 lb-ft @ 4,400 rpm',
                drivetrain: 'AWD (ATTESA E-TS Pro)',
                special: 'Known for its highly tuneable engine and advanced AWD system, making it an unbeatable track monster in its era.',
                svg: `
                    <svg viewBox="0 0 100 60" xmlns="http://www.w3.org/2000/svg" class="w-full h-full">
                        <defs>
                            <linearGradient id="gtr-body" x1="0%" y1="0%" x2="0%" y2="100%">
                                <stop offset="0%" style="stop-color:#2E5CB8;stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#1A3D8F;stop-opacity:1" />
                            </linearGradient>
                            <linearGradient id="gtr-hood" x1="0%" y1="0%" x2="0%" y2="100%">
                                <stop offset="0%" style="stop-color:#3366CC;stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#264D99;stop-opacity:1" />
                            </linearGradient>
                        </defs>
                        
                        <!-- Ground shadows -->
                        <ellipse cx="20" cy="58" rx="8" ry="2" fill="#000" opacity="0.25"/>
                        <ellipse cx="80" cy="58" rx="8" ry="2" fill="#000" opacity="0.25"/>
                        
                        <!-- Main Body - Bayside Blue (signature R34 color) -->
                        <path d="M 5 26 L 10 22 L 90 20 L 95 24 L 95 38 L 5 40 Z" fill="url(#gtr-body)" stroke="#1A3366" stroke-width="0.5"/>
                        
                        <!-- Hood with bulge (NACA duct style) -->
                        <path d="M 72 20 L 90 20 L 95 24 L 95 30 L 72 28 Z" fill="url(#gtr-hood)" stroke="#1A3366" stroke-width="0.3"/>
                        
                        <!-- Hood vents (functional NACA ducts) -->
                        <path d="M 78 22 L 82 21 L 82 26 L 78 27 Z" fill="#1A2A50" opacity="0.7"/>
                        <path d="M 84 21 L 88 20 L 88 25 L 84 26 Z" fill="#1A2A50" opacity="0.7"/>
                        
                        <!-- Front Bumper (aggressive R34 style) -->
                        <path d="M 90 24 L 98 23 L 98 37 L 90 38 Z" fill="#1A3D8F" stroke="#102A66" stroke-width="0.3"/>
                        
                        <!-- Front air intake (large opening) -->
                        <rect x="91" y="30" width="5" height="6" fill="#0A0A0A" rx="0.5"/>
                        
                        <!-- Rear section with wing mount -->
                        <path d="M 3 25 L 8 24 L 8 40 L 3 39 Z" fill="#1A3D8F" stroke="#102A66" stroke-width="0.3"/>
                        
                        <!-- Massive GT-R rear wing (iconic) -->
                        <rect x="1" y="16" width="2" height="3" fill="#1A1A1A"/>
                        <rect x="0" y="14" width="4" height="3" fill="#1A1A1A" rx="0.5"/>
                        <path d="M -1 14 L 5 12 L 5 15 L -1 17 Z" fill="#222" stroke="#111" stroke-width="0.3"/>
                        
                        <!-- Cabin/Roof (boxy R34 shape) -->
                        <path d="M 28 22 L 34 16 L 66 15 L 72 20 L 70 32 L 30 33 Z" fill="#101828" stroke="#0A1020" stroke-width="0.4"/>
                        
                        <!-- Front Windshield (steep angle) -->
                        <path d="M 34 18 L 42 15 L 52 15 L 50 32 L 32 32 Z" fill="#5A9FD4" opacity="0.8" stroke="#333" stroke-width="0.3"/>
                        
                        <!-- Rear Windshield -->
                        <path d="M 54 16 L 66 16 L 70 22 L 68 32 L 56 32 Z" fill="#5A9FD4" opacity="0.6" stroke="#333" stroke-width="0.3"/>
                        
                        <!-- Side Window -->
                        <path d="M 51 17 L 54 17 L 54 31 L 51 31 Z" fill="#5A9FD4" opacity="0.5"/>
                        
                        <!-- GT-R badge line (signature side stripe) -->
                        <path d="M 8 30 L 90 28" stroke="#C0C0C0" stroke-width="0.8" opacity="0.5"/>
                        
                        <!-- Side mirrors (carbon fiber style) -->
                        <rect x="28" y="14" width="3" height="3" fill="#1A1A1A" rx="0.5"/>
                        
                        <!-- Door line -->
                        <line x1="52" y1="20" x2="52" y2="38" stroke="#1A3366" stroke-width="0.5"/>
                        
                        <!-- Door handle (chrome) -->
                        <rect x="44" y="27" width="3" height="1.2" fill="#AAA" rx="0.3"/>
                        <rect x="58" y="27" width="3" height="1.2" fill="#AAA" rx="0.3"/>
                        
                        <!-- Quad Round Headlights (R34 signature) -->
                        <circle cx="93" cy="25" r="2.2" fill="#FFFDE7" stroke="#FFD700" stroke-width="0.4"/>
                        <circle cx="93" cy="25" r="1.4" fill="#FFF" opacity="0.9"/>
                        <circle cx="93" cy="32" r="2.2" fill="#FFFDE7" stroke="#FFD700" stroke-width="0.4"/>
                        <circle cx="93" cy="32" r="1.4" fill="#FFF" opacity="0.9"/>
                        
                        <!-- Front turn signals -->
                        <rect x="96" y="26" width="1.5" height="2" fill="#FFB300" opacity="0.8" rx="0.3"/>
                        <rect x="96" y="30" width="1.5" height="2" fill="#FFB300" opacity="0.8" rx="0.3"/>
                        
                        <!-- Iconic R34 Round Taillights (4 circles) -->
                        <circle cx="5" cy="27" r="2" fill="#CC0000"/>
                        <circle cx="5" cy="27" r="1.2" fill="#FF3333" opacity="0.8"/>
                        <circle cx="5" cy="34" r="2" fill="#CC0000"/>
                        <circle cx="5" cy="34" r="1.2" fill="#FF3333" opacity="0.8"/>
                        
                        <!-- Lower body accent -->
                        <path d="M 8 36 L 90 35 L 90 40 L 5 40 Z" fill="#0D1F4D" opacity="0.5"/>
                        
                        <!-- Front Wheel (NISMO LM GT4 style - 6 spoke) -->
                        <circle cx="20" cy="49" r="9" fill="#1A1A1A" stroke="#0D0D0D" stroke-width="0.5"/>
                        <circle cx="20" cy="49" r="7" fill="#252525"/>
                        <circle cx="20" cy="49" r="5.5" fill="#333"/>
                        <circle cx="20" cy="49" r="2.5" fill="#B8860B"/>
                        <path d="M 20 42 L 21 46 L 20 49 L 19 46 Z" fill="#555"/>
                        <path d="M 26 46 L 23 48 L 20 49 L 22 46 Z" fill="#555"/>
                        <path d="M 26 52 L 23 50 L 20 49 L 22 52 Z" fill="#555"/>
                        <path d="M 20 56 L 19 52 L 20 49 L 21 52 Z" fill="#555"/>
                        <path d="M 14 52 L 17 50 L 20 49 L 18 52 Z" fill="#555"/>
                        <path d="M 14 46 L 17 48 L 20 49 L 18 46 Z" fill="#555"/>
                        
                        <!-- Rear Wheel -->
                        <circle cx="80" cy="49" r="9" fill="#1A1A1A" stroke="#0D0D0D" stroke-width="0.5"/>
                        <circle cx="80" cy="49" r="7" fill="#252525"/>
                        <circle cx="80" cy="49" r="5.5" fill="#333"/>
                        <circle cx="80" cy="49" r="2.5" fill="#B8860B"/>
                        <path d="M 80 42 L 81 46 L 80 49 L 79 46 Z" fill="#555"/>
                        <path d="M 86 46 L 83 48 L 80 49 L 82 46 Z" fill="#555"/>
                        <path d="M 86 52 L 83 50 L 80 49 L 82 52 Z" fill="#555"/>
                        <path d="M 80 56 L 79 52 L 80 49 L 81 52 Z" fill="#555"/>
                        <path d="M 74 52 L 77 50 L 80 49 L 78 52 Z" fill="#555"/>
                        <path d="M 74 46 L 77 48 L 80 49 L 78 46 Z" fill="#555"/>
                        
                        <!-- Metallic shine -->
                        <ellipse cx="50" cy="26" rx="28" ry="5" fill="#FFF" opacity="0.1"/>
                    </svg>
                `
            },
            'BRZ': {
                name: 'Subaru BRZ',
                subtitle: 'The Agile Handler',
                image: 'https://placehold.co/400x200/4F46E5/ffffff?text=Subaru+BRZ', 
                engine: 'FA20 2.0L H4 Boxer',
                hp: '200 hp @ 7,000 rpm',
                torque: '151 lb-ft @ 6,400 rpm',
                drivetrain: 'FR (Front-Engine, Rear-Wheel Drive)',
                special: 'Designed purely for driving pleasure and balance. It prioritizes handling and driver feedback over raw straight-line speed.',
                svg: `
                    <svg viewBox="0 0 100 60" xmlns="http://www.w3.org/2000/svg" class="w-full h-full">
                        <defs>
                            <linearGradient id="brz-body" x1="0%" y1="0%" x2="0%" y2="100%">
                                <stop offset="0%" style="stop-color:#DC2626;stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#991B1B;stop-opacity:1" />
                            </linearGradient>
                            <linearGradient id="brz-roof" x1="0%" y1="0%" x2="0%" y2="100%">
                                <stop offset="0%" style="stop-color:#1F2937;stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#111827;stop-opacity:1" />
                            </linearGradient>
                        </defs>
                        
                        <!-- Ground shadows -->
                        <ellipse cx="20" cy="58" rx="7" ry="1.8" fill="#000" opacity="0.2"/>
                        <ellipse cx="78" cy="58" rx="7" ry="1.8" fill="#000" opacity="0.2"/>
                        
                        <!-- Main Body - Racing Red (characteristic BRZ color) -->
                        <path d="M 8 26 L 12 22 L 88 20 L 94 24 L 94 38 L 8 40 Z" fill="url(#brz-body)" stroke="#8B0000" stroke-width="0.5"/>
                        
                        <!-- Sporty hood bulge -->
                        <path d="M 70 20 L 88 20 L 94 24 L 94 30 L 70 28 Z" fill="#B91C1C" opacity="0.8"/>
                        
                        <!-- Front bumper (aggressive but refined) -->
                        <path d="M 88 24 L 96 23 L 96 37 L 88 38 Z" fill="#1A1A1A" stroke="#000" stroke-width="0.3"/>
                        
                        <!-- Front grille/air intake (trademark BRZ styling) -->
                        <path d="M 89 28 L 94 27 L 94 33 L 89 34 Z" fill="#333" opacity="0.8"/>
                        <line x1="89" y1="29" x2="94" y2="29" stroke="#555" stroke-width="0.4"/>
                        <line x1="89" y1="31" x2="94" y2="31" stroke="#555" stroke-width="0.4"/>
                        
                        <!-- Lower front splitter (modern sports car detail) -->
                        <path d="M 88 34 L 95 33 L 95 37 L 88 38 Z" fill="#000" opacity="0.6"/>
                        
                        <!-- Rear bumper -->
                        <path d="M 5 27 L 10 26 L 10 40 L 5 39 Z" fill="#1A1A1A" stroke="#000" stroke-width="0.3"/>
                        
                        <!-- Cabin/Roof (flowing design - signature BRZ curves) -->
                        <path d="M 28 22 L 34 16 L 66 14 L 72 20 L 70 32 L 30 33 Z" fill="url(#brz-roof)" stroke="#000" stroke-width="0.4"/>
                        
                        <!-- Front Windshield (modern angle) -->
                        <path d="M 34 18 L 42 14 L 52 14 L 50 32 L 32 32 Z" fill="#5DADE2" opacity="0.8" stroke="#333" stroke-width="0.3"/>
                        
                        <!-- Rear Windshield -->
                        <path d="M 54 15 L 66 15 L 70 20 L 68 32 L 56 32 Z" fill="#5DADE2" opacity="0.6" stroke="#333" stroke-width="0.3"/>
                        
                        <!-- Side Window -->
                        <path d="M 51 16 L 54 16 L 54 31 L 51 31 Z" fill="#5DADE2" opacity="0.5"/>
                        
                        <!-- Iconic BRZ side stripe/shoulder line -->
                        <path d="M 8 30 L 88 29" stroke="#FFB300" stroke-width="0.6" opacity="0.7"/>
                        
                        <!-- Side mirrors (sleek carbon-style) -->
                        <rect x="28" y="14" width="3" height="3" fill="#1A1A1A" rx="0.5"/>
                        
                        <!-- Door line (clean and sporty) -->
                        <line x1="52" y1="20" x2="52" y2="38" stroke="#666" stroke-width="0.4"/>
                        
                        <!-- Door handles (chrome accents) -->
                        <rect x="44" y="27" width="3" height="1.2" fill="#AAA" rx="0.3"/>
                        <rect x="58" y="27" width="3" height="1.2" fill="#AAA" rx="0.3"/>
                        
                        <!-- LED Headlights (modern angular design) -->
                        <path d="M 87 22 L 94 21 L 94 26 L 87 27 Z" fill="#333"/>
                        <circle cx="89" cy="23" r="1.5" fill="#FFFACD"/>
                        <circle cx="92" cy="23" r="1.5" fill="#FFFACD"/>
                        
                        <path d="M 87 30 L 94 29 L 94 34 L 87 35 Z" fill="#333"/>
                        <circle cx="89" cy="31" r="1.5" fill="#FFFACD"/>
                        <circle cx="92" cy="31" r="1.5" fill="#FFFACD"/>
                        
                        <!-- Turn signals (amber) -->
                        <circle cx="95" cy="24" r="1" fill="#FFB300" opacity="0.8"/>
                        <circle cx="95" cy="32" r="1" fill="#FFB300" opacity="0.8"/>
                        
                        <!-- Rear taillights (modern LED bars) -->
                        <rect x="5" y="26" width="2.5" height="7" fill="#CC0000" rx="0.5"/>
                        <line x1="6.25" y1="28" x2="6.25" y2="30" stroke="#FF4444" stroke-width="0.6"/>
                        <line x1="6.25" y1="31" x2="6.25" y2="33" stroke="#FF4444" stroke-width="0.6"/>
                        
                        <!-- Lower body accent (design continuity) -->
                        <path d="M 8 36 L 88 35 L 88 40 L 5 40 Z" fill="#8B0000" opacity="0.4"/>
                        
                        <!-- Front Wheel (lightweight mesh pattern - BRZ style) -->
                        <circle cx="20" cy="49" r="9" fill="#1A1A1A" stroke="#0D0D0D" stroke-width="0.5"/>
                        <circle cx="20" cy="49" r="7" fill="#2A2A2A"/>
                        <circle cx="20" cy="49" r="5" fill="#333"/>
                        <circle cx="20" cy="49" r="2.5" fill="#666"/>
                        <line x1="20" y1="42" x2="20" y2="56" stroke="#777" stroke-width="0.8"/>
                        <line x1="13" y1="49" x2="27" y2="49" stroke="#777" stroke-width="0.8"/>
                        <line x1="15" y1="44" x2="25" y2="54" stroke="#777" stroke-width="0.6"/>
                        <line x1="25" y1="44" x2="15" y2="54" stroke="#777" stroke-width="0.6"/>
                        <line x1="16" y1="42" x2="24" y2="42" stroke="#555" stroke-width="0.4" opacity="0.5"/>
                        <line x1="16" y1="56" x2="24" y2="56" stroke="#555" stroke-width="0.4" opacity="0.5"/>
                        
                        <!-- Rear Wheel -->
                        <circle cx="80" cy="49" r="9" fill="#1A1A1A" stroke="#0D0D0D" stroke-width="0.5"/>
                        <circle cx="80" cy="49" r="7" fill="#2A2A2A"/>
                        <circle cx="80" cy="49" r="5" fill="#333"/>
                        <circle cx="80" cy="49" r="2.5" fill="#666"/>
                        <line x1="80" y1="42" x2="80" y2="56" stroke="#777" stroke-width="0.8"/>
                        <line x1="73" y1="49" x2="87" y2="49" stroke="#777" stroke-width="0.8"/>
                        <line x1="75" y1="44" x2="85" y2="54" stroke="#777" stroke-width="0.6"/>
                        <line x1="85" y1="44" x2="75" y2="54" stroke="#777" stroke-width="0.6"/>
                        <line x1="76" y1="42" x2="84" y2="42" stroke="#555" stroke-width="0.4" opacity="0.5"/>
                        <line x1="76" y1="56" x2="84" y2="56" stroke="#555" stroke-width="0.4" opacity="0.5"/>
                        
                        <!-- Metallic shine -->
                        <ellipse cx="50" cy="26" rx="28" ry="5" fill="#FFF" opacity="0.12"/>
                    </svg>
                `
            }
        };


        // --- Page Navigation Logic ---
        const menuNav = document.getElementById('menu-nav');
        const mainTitle = document.getElementById('main-title');
        let currentPage = 'menu';

        function showPage(pageId) {
            
            // 1. Reset games if navigating away
            if (currentPage === 'cps-tester' && pageId !== 'cps-tester') resetCPSTester();
            if (currentPage === 'reaction-tester' && pageId !== 'reaction-tester') resetReactionTester();
            if (currentPage === 'driving-view' && pageId !== 'driving-view') CarGame.stop(); // Stop the game loop

            // If navigating to practice, ensure we start on the selection view
            if (pageId === 'practice') {
                showCarSelectView();
            }

            const pages = document.querySelectorAll('.page');
            const backgroundVideo = document.getElementById('background-video');
            const practiceVideo = document.getElementById('practice-video');
            
            // 2. Hide/Show Menu and Title + Background Video
            if (pageId === 'menu') {
                menuNav.classList.remove('hidden', 'opacity-0');
                mainTitle.classList.remove('hidden', 'opacity-0');
                if (backgroundVideo) {
                    backgroundVideo.style.opacity = '1';
                    backgroundVideo.play();
                }
                // Stop practice video when returning to menu
                if (practiceVideo) {
                    practiceVideo.pause();
                    practiceVideo.style.opacity = '0';
                }
                const practiceBtn = document.getElementById('practice-sound-toggle');
                if (practiceBtn) practiceBtn.classList.remove('visible');
            } else {
                menuNav.classList.add('hidden', 'opacity-0');
                mainTitle.classList.add('hidden', 'opacity-0');
                if (backgroundVideo) backgroundVideo.style.opacity = '0';
            }
            
            // 3. Hide all content pages
            pages.forEach(page => {
                page.classList.remove('page-visible');
            });
            
            // 4. Show the requested content page
            if (pageId !== 'menu') {
                const newPage = document.getElementById(pageId);
                if (newPage) {
                    newPage.classList.add('page-visible');
                }
            }
            
            currentPage = pageId;
        }

        // --- Practice Mode Logic (Carousel + Map Selection + Driving) ---
        const carSelectView = document.getElementById('car-select-view');
        const mapSelectionView = document.getElementById('map-selection-view');
        const drivingView = document.getElementById('driving-view');

        /** Transitions to the Car Selection View */
        function showCarSelectView() {
            mapSelectionView.classList.add('hidden'); 
            drivingView.classList.add('hidden'); // Hide driving view
            carSelectView.classList.remove('hidden');
            // Show practice video and button, hide menu video
            const practiceVideo = document.getElementById('practice-video');
            const practiceBtn = document.getElementById('practice-sound-toggle');
            const backgroundVideo = document.getElementById('background-video');
            if (backgroundVideo) {
                backgroundVideo.pause();
                backgroundVideo.style.opacity = '0';
            }
            if (practiceVideo) practiceVideo.style.opacity = '1';
            if (practiceBtn) practiceBtn.classList.add('visible');
            if (practiceVideo) practiceVideo.play();
            const carousel = document.getElementById('car-carousel');
            if (carousel) {
                updateIndicators(Math.round(carousel.scrollLeft / carousel.clientWidth));
            }
        }


        /** Transitions to the Map Selection View (Random/Maps) */
        function showMapSelectionView() {
            carSelectView.classList.add('hidden');
            drivingView.classList.add('hidden'); // Hide driving view
            mapSelectionView.classList.remove('hidden');
            CarGame.stop(); // Ensure the game stops if we exit via the 'End Practice' button
        }
        
        /** Transitions to the Driving View (Game) */
        function showDrivingView() {
            mapSelectionView.classList.add('hidden'); 
            carSelectView.classList.add('hidden');
            drivingView.classList.remove('hidden');
            // Hide practice video and button (game takes over, black background)
            const practiceVideo = document.getElementById('practice-video');
            const practiceBtn = document.getElementById('practice-sound-toggle');
            if (practiceVideo) {
                practiceVideo.pause();
                practiceVideo.style.opacity = '0';
            }
            if (practiceBtn) practiceBtn.classList.remove('visible');
            
            // Inject the selected car's SVG before starting the game
            CarGame.init(currentSelectedCarId); 
        }
        
        /** End the game and return to car select view */
        function endRacePractice() {
            CarGame.stop();
            showCarSelectView();
        }

        /**
         * Selects a car and starts the race directly (no details view).
         * @param {string} carKey - The key for the car in the carData object ('AE86', 'GTR', 'BRZ').
         */
        function selectCar(carKey) {
            const data = carData[carKey];
            if (!data) return; 

            // Store selected car ID
            currentSelectedCarId = carKey;
            
            // Start race immediately without showing car details
            showDrivingView();
        }

        /** Handles starting the race (now directs to the driving view for 'random') */
        function startRace(mode) {
            if (mode === 'random') {
                showDrivingView();
            } else {
                alertBox('Map selection is disabled for the Grid Game. Please press "Start Grid Game".');
            }
        }

        /** Placeholder for showing the map list (future feature) */
        function showMapsList() {
            alertBox('Functionality to select a specific map is not yet implemented for the Grid Game.');
        }

        function scrollCarousel(direction) {
            const container = document.getElementById('car-carousel');
            if (!container) return;

            const scrollAmount = container.clientWidth;
            container.scrollBy({
                left: scrollAmount * direction,
                behavior: 'smooth'
            });
            
            setTimeout(() => {
                const index = Math.round(container.scrollLeft / container.clientWidth);
                updateIndicators(index);
            }, 300);
        }
        
        const carCarousel = document.getElementById('car-carousel');
        if (carCarousel) {
            carCarousel.addEventListener('scroll', () => {
                const index = Math.round(carCarousel.scrollLeft / carCarousel.clientWidth);
                updateIndicators(index);
            });
        }

        function updateIndicators(activeIndex) {
            const indicators = document.querySelectorAll('.indicator');
            indicators.forEach((ind, i) => {
                if (i === activeIndex) {
                    ind.classList.remove('bg-gray-300');
                    ind.classList.add('bg-gray-800');
                } else {
                    ind.classList.remove('bg-gray-800');
                    ind.classList.add('bg-gray-300');
                }
            });
        }
        
        // --- Grid Game Logic (OVERHAUL) ---
        const CarGame = {
            // Game Constants
            GRID_ROWS: 5,               // 5 vertical lanes
            GRID_HEIGHT_PERCENT: 20,    // 100% / 5 lanes
            MOVE_FORWARD_STEPS: 1,      // 1 click = 1 grid movement
            TRAP_SPAWN_RANGE: 4,        // Traps spawn 4 grids ahead
            
            // DOM Elements
            car: null,
            track: null,
            trapContainer: null,
            scoreDisplay: null,
            gameOverMessage: null,
            finalScoreDisplay: null,

            // Game State
            currentLane: 2, // 0 (top) to 4 (bottom) - Start center
            score: 0,
            traps: [],      // [{lane: 0-4, forwardSteps: 4}]
            isGameOver: true,
            gameStartTime: null,
            elapsedTime: 0,
            timerInterval: null,
            timerDisplay: null,
            gameTimerStarted: false,
            playerHasMoved: false,
            engineIdleInterval: null,
            currentCarId: 'AE86',
            accSoundTimeout: null,
            idleTimeout: null,
            lastMoveTime: 0,
            isAccSoundPlaying: false,
            
            init(carId) {
                this.car = document.getElementById('game-car');
                this.track = document.getElementById('game-track');
                this.trapContainer = document.getElementById('trap-container');
                this.scoreDisplay = document.getElementById('current-score-display');
                this.gameOverMessage = document.getElementById('game-over-message');
                this.finalScoreDisplay = document.getElementById('final-game-score');
                this.timerDisplay = document.getElementById('game-timer-display');
                this.currentCarId = carId || 'AE86';
                
                if (!this.car || !this.track || !this.trapContainer || !this.scoreDisplay || !this.gameOverMessage || !this.timerDisplay) {
                    console.error("Game elements not found.");
                    return;
                }
                
                // Set the correct car SVG
                if (carData[carId] && carData[carId].svg) {
                    this.car.innerHTML = carData[carId].svg;
                } else {
                    console.error("Selected car SVG not found. Using default.");
                    this.car.innerHTML = carData['AE86'].svg; 
                }


                // Set up event listeners
                this.boundHandleKey = this.handleKey.bind(this);
                this.boundHandleClick = this.handleClick.bind(this);
                document.addEventListener('keydown', this.boundHandleKey);
                this.track.addEventListener('mousedown', this.boundHandleClick);
                this.track.addEventListener('touchstart', this.boundHandleClick);
                
                this.reset();
            },
            
            stop() {
                // Clean up listeners
                document.removeEventListener('keydown', this.boundHandleKey);
                this.track.removeEventListener('mousedown', this.boundHandleClick);
                this.track.removeEventListener('touchstart', this.boundHandleClick);
                // Stop timer
                if (this.timerInterval) clearInterval(this.timerInterval);
                // Stop all sounds
                this.stopAllSounds();
            },

            reset() {
                this.isGameOver = false;
                this.currentLane = 2; // Middle lane
                this.score = 0;
                this.traps = [];
                this.elapsedTime = 0;
                this.gameTimerStarted = false;
                this.playerHasMoved = false;
                this.lastMoveTime = 0;
                this.isAccSoundPlaying = false;
                
                // Stop previous timer if exists
                if (this.timerInterval) clearInterval(this.timerInterval);
                
                // Stop all sounds and clear timeouts
                this.stopAllSounds();
                
                this.gameOverMessage.style.display = 'none';
                this.timerDisplay.textContent = '0s';
                
                // Play engine start sound (loops until first move)
                this.playEngineStart();
                
                // Initial render
                this.render();
                this.updateDisplay();
                
                // Spawn first set of traps
                this.spawnTraps(this.TRAP_SPAWN_RANGE);
            },
            
            isMuted() {
                return document.getElementById('sound-toggle').classList.contains('muted');
            },
            
            playEngineStart() {
                try {
                    if (this.isMuted()) return;
                    const sound = document.getElementById('engine-start-sound');
                    if (sound) {
                        sound.currentTime = 0;
                        sound.loop = true;
                        sound.play().catch(() => {});
                    }
                } catch (e) {}
            },
            
            stopEngineStart() {
                try {
                    const sound = document.getElementById('engine-start-sound');
                    if (sound) {
                        sound.pause();
                        sound.currentTime = 0;
                    }
                } catch (e) {}
            },
            
            getCarAccSoundId() {
                switch(this.currentCarId) {
                    case 'AE86': return 'toyota-acc-sound';
                    case 'GTR': return 'nissan-acc-sound';
                    case 'BRZ': return 'subaru-acc-sound';
                    default: return 'toyota-acc-sound';
                }
            },
            
            playCarAccSound() {
                try {
                    if (this.isMuted()) return;
                    
                    const soundId = this.getCarAccSoundId();
                    const sound = document.getElementById(soundId);
                    if (!sound) return;
                    
                    // If already playing, just extend the timeout
                    if (this.isAccSoundPlaying) {
                        if (this.accSoundTimeout) clearTimeout(this.accSoundTimeout);
                        this.accSoundTimeout = setTimeout(() => {
                            sound.pause();
                            sound.currentTime = 0;
                            this.isAccSoundPlaying = false;
                            this.checkForIdle();
                        }, 3000);
                        return;
                    }
                    
                    // Start playing
                    sound.currentTime = 0;
                    sound.play().catch(() => {});
                    this.isAccSoundPlaying = true;
                    
                    // Stop after 3 seconds
                    if (this.accSoundTimeout) clearTimeout(this.accSoundTimeout);
                    this.accSoundTimeout = setTimeout(() => {
                        sound.pause();
                        sound.currentTime = 0;
                        this.isAccSoundPlaying = false;
                        this.checkForIdle();
                    }, 3000);
                } catch (e) {}
            },
            
            stopCarAccSound() {
                try {
                    if (this.accSoundTimeout) {
                        clearTimeout(this.accSoundTimeout);
                        this.accSoundTimeout = null;
                    }
                    ['toyota-acc-sound', 'nissan-acc-sound', 'subaru-acc-sound'].forEach(id => {
                        const sound = document.getElementById(id);
                        if (sound) {
                            sound.pause();
                            sound.currentTime = 0;
                        }
                    });
                    this.isAccSoundPlaying = false;
                } catch (e) {}
            },
            
            checkForIdle() {
                // Clear any existing idle timeout
                if (this.idleTimeout) clearTimeout(this.idleTimeout);
                
                // Only check if game is still running and player has moved
                if (this.isGameOver || !this.playerHasMoved) return;
                
                // Set a timeout to detect if player stops moving
                this.idleTimeout = setTimeout(() => {
                    if (!this.isGameOver && this.playerHasMoved && !this.isAccSoundPlaying) {
                        this.playIdleSound();
                    }
                }, 500);
            },
            
            playIdleSound() {
                try {
                    if (this.isMuted() || this.isGameOver) return;
                    const sound = document.getElementById('supra-ratatatata-sound');
                    if (sound) {
                        sound.currentTime = 0;
                        sound.play().catch(() => {});
                    }
                } catch (e) {}
            },
            
            stopIdleSound() {
                try {
                    const sound = document.getElementById('supra-ratatatata-sound');
                    if (sound) {
                        sound.pause();
                        sound.currentTime = 0;
                    }
                    if (this.idleTimeout) {
                        clearTimeout(this.idleTimeout);
                        this.idleTimeout = null;
                    }
                } catch (e) {}
            },
            
            crashSoundTimeout: null,
            crashAudioNodes: [],
            
            playCrashSound() {
                try {
                    if (this.isMuted()) return;
                    
                    const audioContext = window.audioContext || (window.audioContext = new (window.AudioContext || window.webkitAudioContext)());
                    const now = audioContext.currentTime;
                    const duration = 60; // Exactly 1 minute
                    
                    // Store nodes for cleanup
                    this.crashAudioNodes = [];
                    
                    // Create a long explosion/fire crackling sound that lasts 1 minute
                    const createCrashLayer = (startTime, layerDuration) => {
                        const bufferSize = audioContext.sampleRate * layerDuration;
                        const noiseBuffer = audioContext.createBuffer(1, bufferSize, audioContext.sampleRate);
                        const noiseData = noiseBuffer.getChannelData(0);
                        
                        for (let i = 0; i < bufferSize; i++) {
                            const t = i / bufferSize;
                            const envelope = Math.exp(-t * 3) * 0.5 + Math.exp(-t * 0.5) * 0.5;
                            noiseData[i] = (Math.random() * 2 - 1) * envelope;
                        }
                        
                        const noiseSource = audioContext.createBufferSource();
                        noiseSource.buffer = noiseBuffer;
                        
                        const lowPass = audioContext.createBiquadFilter();
                        lowPass.type = 'lowpass';
                        lowPass.frequency.setValueAtTime(800, startTime);
                        lowPass.frequency.exponentialRampToValueAtTime(200, startTime + layerDuration);
                        
                        const noiseGain = audioContext.createGain();
                        noiseSource.connect(lowPass);
                        lowPass.connect(noiseGain);
                        noiseGain.connect(audioContext.destination);
                        noiseGain.gain.setValueAtTime(0.3, startTime);
                        noiseGain.gain.exponentialRampToValueAtTime(0.01, startTime + layerDuration);
                        
                        noiseSource.start(startTime);
                        noiseSource.stop(startTime + layerDuration);
                        this.crashAudioNodes.push(noiseSource);
                    };
                    
                    // Initial loud explosion
                    const boomOsc = audioContext.createOscillator();
                    const boomGain = audioContext.createGain();
                    boomOsc.connect(boomGain);
                    boomGain.connect(audioContext.destination);
                    boomOsc.type = 'sine';
                    boomOsc.frequency.setValueAtTime(150, now);
                    boomOsc.frequency.exponentialRampToValueAtTime(20, now + 2);
                    boomGain.gain.setValueAtTime(0.5, now);
                    boomGain.gain.exponentialRampToValueAtTime(0.01, now + 3);
                    boomOsc.start(now);
                    boomOsc.stop(now + 3);
                    this.crashAudioNodes.push(boomOsc);
                    
                    // Create crackling layers throughout the duration
                    for (let i = 0; i < 20; i++) {
                        createCrashLayer(now + i * 3, Math.min(5, duration - i * 3));
                    }
                    
                    // Stop after exactly 1 minute
                    this.crashSoundTimeout = setTimeout(() => {
                        this.stopCrashSound();
                    }, 60000);
                    
                } catch (e) {}
            },
            
            stopCrashSound() {
                try {
                    if (this.crashSoundTimeout) {
                        clearTimeout(this.crashSoundTimeout);
                        this.crashSoundTimeout = null;
                    }
                    this.crashAudioNodes.forEach(node => {
                        try { node.stop(); } catch(e) {}
                    });
                    this.crashAudioNodes = [];
                } catch (e) {}
            },
            
            stopAllSounds() {
                this.stopEngineStart();
                this.stopCarAccSound();
                this.stopIdleSound();
                this.stopCrashSound();
            },
            
            handleKey(e) {
                if (this.isGameOver) return;
                const key = e.key.toLowerCase();
                
                let direction = 0; // 0 for stationary step, -1 for up, 1 for down

                if (key === 'w') {
                    direction = -1;
                    e.preventDefault(); 
                } else if (key === 's') {
                    direction = 1;
                    e.preventDefault();
                } else {
                    return;
                }
                
                this.changeLaneAndStep(direction);
            },

            handleClick(e) {
                if (this.isGameOver) return;
                // Check if the click is on the track background, not a trap or the car
                if (e.target.id === 'game-track' || e.target.id === 'trap-container') {
                    e.preventDefault();
                    // Click/Touch only triggers a forward step (0 vertical movement)
                    this.changeLaneAndStep(0); 
                }
            },
            
            changeLaneAndStep(direction) {
                if (this.isGameOver) return;
                
                // On first move: stop engine start sound, then play car acceleration
                if (!this.playerHasMoved) {
                    this.playerHasMoved = true;
                    this.stopEngineStart(); // Stop engine start sound
                }
                
                // Stop idle sound when moving again (sounds play sequentially)
                this.stopIdleSound();
                
                // Start timer on first move
                if (!this.gameTimerStarted) {
                    this.gameTimerStarted = true;
                    this.gameStartTime = Date.now();
                    this.timerInterval = setInterval(() => {
                        this.elapsedTime = Math.floor((Date.now() - this.gameStartTime) / 1000);
                        this.updateTimer();
                    }, 100);
                }
                
                // Play car-specific acceleration sound
                this.playCarAccSound();
                this.lastMoveTime = Date.now();
                
                // 1. Calculate new lane (if direction is not 0)
                if (direction !== 0) {
                    const newLane = this.currentLane + direction;
                    if (newLane >= 0 && newLane < this.GRID_ROWS) {
                        this.currentLane = newLane;
                    }
                }
                
                // 2. Execute forward step (moves traps)
                this.stepForward();
                
                // 3. Render immediately
                this.render();
            },
            
            playMoveSound() {
                try {
                    if (document.getElementById('sound-toggle').classList.contains('muted')) return;
                    
                    const audioContext = window.audioContext || (window.audioContext = new (window.AudioContext || window.webkitAudioContext)());
                    const now = audioContext.currentTime;
                    const duration = 0.15;
                    
                    // V8 Engine characteristics - deep rumble with firing pulses
                    
                    // Low frequency rumble (engine block)
                    const bassOsc = audioContext.createOscillator();
                    const bassGain = audioContext.createGain();
                    bassOsc.connect(bassGain);
                    bassGain.connect(audioContext.destination);
                    bassOsc.type = 'sine';
                    bassOsc.frequency.setValueAtTime(80, now);
                    bassOsc.frequency.linearRampToValueAtTime(150, now + 0.07);
                    bassOsc.frequency.linearRampToValueAtTime(100, now + duration);
                    bassGain.gain.setValueAtTime(0.25, now);
                    bassGain.gain.linearRampToValueAtTime(0.3, now + 0.06);
                    bassGain.gain.linearRampToValueAtTime(0, now + duration);
                    
                    // Mid frequency (cylinder firing)
                    const midOsc = audioContext.createOscillator();
                    const midGain = audioContext.createGain();
                    midOsc.connect(midGain);
                    midGain.connect(audioContext.destination);
                    midOsc.type = 'sine';
                    midOsc.frequency.setValueAtTime(200, now);
                    midOsc.frequency.linearRampToValueAtTime(350, now + 0.08);
                    midOsc.frequency.linearRampToValueAtTime(250, now + duration);
                    midGain.gain.setValueAtTime(0.2, now);
                    midGain.gain.linearRampToValueAtTime(0.28, now + 0.06);
                    midGain.gain.linearRampToValueAtTime(0, now + duration);
                    
                    // High harmonic (valve noise)
                    const highOsc = audioContext.createOscillator();
                    const highGain = audioContext.createGain();
                    highOsc.connect(highGain);
                    highGain.connect(audioContext.destination);
                    highOsc.type = 'sine';
                    highOsc.frequency.setValueAtTime(400, now);
                    highOsc.frequency.linearRampToValueAtTime(550, now + 0.08);
                    highOsc.frequency.linearRampToValueAtTime(420, now + duration);
                    highGain.gain.setValueAtTime(0.12, now);
                    highGain.gain.linearRampToValueAtTime(0.18, now + 0.05);
                    highGain.gain.linearRampToValueAtTime(0, now + duration);
                    
                    // Engine knock/firing pulse noise
                    const bufferSize = audioContext.sampleRate * duration;
                    const noiseBuffer = audioContext.createBuffer(1, bufferSize, audioContext.sampleRate);
                    const noiseData = noiseBuffer.getChannelData(0);
                    
                    // Create pulsating noise pattern (V8 8-cylinder firing)
                    const fireRate = 8;
                    for (let i = 0; i < bufferSize; i++) {
                        const phase = (i / audioContext.sampleRate) * fireRate * Math.PI * 2;
                        const pulse = Math.sin(phase) > 0.7 ? 1 : 0;
                        noiseData[i] = (Math.random() * 2 - 1) * pulse * (1 - i / bufferSize);
                    }
                    
                    const noiseSource = audioContext.createBufferSource();
                    noiseSource.buffer = noiseBuffer;
                    
                    // Multi-stage filter for engine texture
                    const noiseBandPass = audioContext.createBiquadFilter();
                    noiseBandPass.type = 'bandpass';
                    noiseBandPass.frequency.setValueAtTime(600, now);
                    noiseBandPass.frequency.linearRampToValueAtTime(900, now + duration);
                    noiseBandPass.Q.setValueAtTime(1.5, now);
                    
                    const noiseGain = audioContext.createGain();
                    noiseSource.connect(noiseBandPass);
                    noiseBandPass.connect(noiseGain);
                    noiseGain.connect(audioContext.destination);
                    noiseGain.gain.setValueAtTime(0.12, now);
                    noiseGain.gain.linearRampToValueAtTime(0.18, now + 0.04);
                    noiseGain.gain.linearRampToValueAtTime(0, now + duration);
                    
                    // Compression-like effect with attack burst
                    const burstOsc = audioContext.createOscillator();
                    const burstGain = audioContext.createGain();
                    burstOsc.connect(burstGain);
                    burstGain.connect(audioContext.destination);
                    burstOsc.type = 'square';
                    burstOsc.frequency.setValueAtTime(250, now);
                    burstGain.gain.setValueAtTime(0, now);
                    burstGain.gain.linearRampToValueAtTime(0.08, now + 0.02);
                    burstGain.gain.linearRampToValueAtTime(0, now + 0.08);
                    
                    bassOsc.start(now);
                    bassOsc.stop(now + duration);
                    midOsc.start(now);
                    midOsc.stop(now + duration);
                    highOsc.start(now);
                    highOsc.stop(now + duration);
                    burstOsc.start(now);
                    burstOsc.stop(now + duration);
                    noiseSource.start(now);
                    noiseSource.stop(now + duration);
                } catch (e) {}
            },

            stepForward() {
                if (this.isGameOver) return;
                
                // 1. Collision Check (Trap is at forwardSteps=0)
                const collisionTrap = this.traps.find(trap => 
                    trap.forwardSteps === 0 && trap.lane === this.currentLane
                );
                
                if (collisionTrap) {
                    this.gameOver();
                    return;
                }

                // 2. Move Traps (1 grid forward, towards the car)
                this.traps = this.traps.map(trap => ({
                    ...trap,
                    forwardSteps: trap.forwardSteps - this.MOVE_FORWARD_STEPS
                })).filter(trap => trap.forwardSteps >= -this.MOVE_FORWARD_STEPS); // Remove traps that are now behind the car

                // 3. Update Score
                this.score += this.MOVE_FORWARD_STEPS; 
                this.updateDisplay();

                // 4. Trap Spawning Logic
                // Spawn a new set of traps when the score is a multiple of 10
                if (this.score % 10 === 0 && this.score > 0) { 
                    this.spawnTraps(this.TRAP_SPAWN_RANGE);
                }
            },
            
            /**
             * Generates a trap pattern that leaves 1 or 2 adjacent safe lanes.
             * @param {number} distance - The forward step distance at which to spawn the traps.
             */
            spawnTraps(distance) {
                // Ensure no trap is spawned if the designated spawn spot already has a trap
                const existingTrapAtSpawn = this.traps.find(trap => trap.forwardSteps === distance);
                if (existingTrapAtSpawn) return;

                const allLanes = [...Array(this.GRID_ROWS).keys()]; // [0, 1, 2, 3, 4]
                let safeLanes = [];

                // 1. Decide on 1 or 2 safe grids (50/50 chance)
                const numSafeLanes = Math.random() < 0.5 ? 1 : 2; 

                if (numSafeLanes === 1) {
                    // Choose 1 random safe lane (0, 1, 2, 3, 4)
                    const safeLane = Math.floor(Math.random() * this.GRID_ROWS);
                    safeLanes.push(safeLane);
                } else {
                    // Choose 2 adjacent safe lanes: (0, 1), (1, 2), (2, 3), or (3, 4)
                    const startingLane = Math.floor(Math.random() * (this.GRID_ROWS - 1)); // 0, 1, 2, or 3
                    safeLanes.push(startingLane);
                    safeLanes.push(startingLane + 1);
                }

                // 2. Determine trap lanes (all lanes NOT in safeLanes)
                const trapLanes = allLanes.filter(lane => !safeLanes.includes(lane));

                // 3. Spawn traps in all trap lanes
                trapLanes.forEach(lane => {
                    this.traps.push({ lane, forwardSteps: distance });
                });
            },

            render() {
                // 1. Render Car Position
                // Calculate the center of the current lane: (lane index * 20%) + (20% / 2)
                const topPercent = this.currentLane * this.GRID_HEIGHT_PERCENT + (this.GRID_HEIGHT_PERCENT / 2);
                this.car.style.top = `${topPercent}%`;
                
                // 2. Render Traps
                this.trapContainer.innerHTML = '';
                this.traps.forEach(trap => {
                    const trapElement = document.createElement('div');
                    trapElement.classList.add('trap');
                    
                    // Vertical position (Y-axis): Aligned to the top of the lane grid
                    const trapTopPercent = trap.lane * this.GRID_HEIGHT_PERCENT;
                    trapElement.style.top = `${trapTopPercent}%`;
                    
                    // Horizontal position (X-axis)
                    // The car is fixed at 25% from the left.
                    // Traps start at 4 steps (100% off-screen) and end at 0 steps (at 25% collision point)
                    const gridMovementRange = 75; // 100% (right edge) - 25% (car position)
                    const maxSteps = this.TRAP_SPAWN_RANGE; // 4 steps total distance
                    
                    // Linear mapping: 
                    // 4 steps -> 100%
                    // 0 steps -> 25%
                    const leftPosition = 25 + (trap.forwardSteps / maxSteps) * gridMovementRange;
                    
                    // Styling near collision point
                    if (trap.forwardSteps <= this.MOVE_FORWARD_STEPS) { // Danger zone (1 click away)
                        trapElement.style.opacity = 1;
                        trapElement.style.transform = 'scale(1.2)';
                    } else {
                        trapElement.style.opacity = 0.8;
                        trapElement.style.transform = 'scale(1)';
                    }
                    
                    trapElement.style.left = `${leftPosition}%`;
                    trapElement.innerHTML = 'üí•';
                    
                    this.trapContainer.appendChild(trapElement);
                });
            },

            updateDisplay() {
                this.scoreDisplay.textContent = this.score;
            },
            
            updateTimer() {
                if (this.timerDisplay) {
                    this.timerDisplay.textContent = this.elapsedTime + 's';
                }
            },

            gameOver() {
                this.isGameOver = true;
                if (this.timerInterval) clearInterval(this.timerInterval);
                
                // Stop all other sounds first (sequential - one sound at a time)
                this.stopAllSounds();
                
                // Play crash sound (lasts exactly 1 minute)
                this.playCrashSound();
                
                const gridsText = this.score === 1 ? 'Grid' : 'Grids';
                const secondsText = this.elapsedTime === 1 ? 'second' : 'seconds';
                this.finalScoreDisplay.textContent = `${this.score} ${gridsText} in ${this.elapsedTime}${secondsText === 'second' ? 's' : 's'}`;
                this.gameOverMessage.style.display = 'flex';
            }
        };

        // --- Mobile Touch Controls ---
        (function initMobileTouchControls() {
            const btnUp = document.getElementById('btn-up');
            const btnDown = document.getElementById('btn-down');
            const btnStep = document.getElementById('btn-step');
            
            function createTouchHandler(direction) {
                return function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    if (CarGame && typeof CarGame.changeLaneAndStep === 'function') {
                        CarGame.changeLaneAndStep(direction);
                    }
                };
            }
            
            function bindButtonEvents(button, direction) {
                if (!button) return;
                const handler = createTouchHandler(direction);
                button.addEventListener('touchstart', handler, { passive: false });
                button.addEventListener('mousedown', function(e) {
                    e.preventDefault();
                    handler(e);
                });
            }
            
            bindButtonEvents(btnUp, -1);    // Move up + step forward
            bindButtonEvents(btnDown, 1);   // Move down + step forward  
            bindButtonEvents(btnStep, 0);   // Step forward only
        })();

        // --- CUSTOM ALERT BOX (Replaces alert() and confirm()) ---
        function alertBox(message) {
            const existingAlert = document.getElementById('custom-alert');
            if (existingAlert) existingAlert.remove();
            
            const alertHtml = `
                <div id="custom-alert" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4">
                    <div class="bg-white rounded-xl p-6 shadow-2xl max-w-sm w-full transform transition-all duration-300 scale-100">
                        <h3 class="text-xl font-bold text-red-600 mb-4">Notification</h3>
                        <p class="text-gray-700 mb-6">${message}</p>
                        <button onclick="document.getElementById('custom-alert').remove()" class="w-full bg-red-600 text-white font-bold py-2 rounded-lg hover:bg-red-700 transition-colors">
                            Close
                        </button>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', alertHtml);
        }

        // --- CPS Tester Logic (Unchanged) ---
        let cpsGameState = 'IDLE';
        let clicks = 0;
        let timeLeft = 5; 
        let timerInterval = null;
        let currentDuration = 5;

        const clickArea = document.getElementById('click-area');
        const cpsTimerDisplay = document.getElementById('cps-timer');
        const cpsClickCountDisplay = document.getElementById('cps-click-count');
        const cpsMessage = document.getElementById('cps-message');
        const cpsTestArea = document.getElementById('cps-test-area');
        const cpsResultsSummary = document.getElementById('cps-results-summary');
        const finalCPSScore = document.getElementById('final-cps-score');
        const finalKMPHScore = document.getElementById('final-kmph-score');
        const finalTotalClicks = document.getElementById('final-total-clicks');
        const finalDurationDisplay = document.getElementById('final-test-duration');
        const durationDisplay = document.getElementById('current-duration-display');

        function updateDurationButtons() {
            const buttons = document.querySelectorAll('.duration-btn');
            buttons.forEach(btn => {
                const duration = parseInt(btn.textContent.replace('s', ''));
                if (duration === currentDuration) {
                    btn.classList.remove('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
                    btn.classList.add('bg-indigo-600', 'text-white', 'ring-2', 'ring-indigo-400');
                } else {
                    btn.classList.remove('bg-indigo-600', 'text-white', 'ring-2', 'ring-indigo-400');
                    btn.classList.add('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
                }
            });
        }

        function setCPSTime(newDuration) {
            if (cpsGameState === 'PLAYING') return; 
            currentDuration = newDuration;
            resetCPSTester(); 
        }


        function resetCPSTester() {
            if (timerInterval) {
                clearInterval(timerInterval);
            }
            
            cpsGameState = 'IDLE';
            clicks = 0;
            timeLeft = currentDuration; 

            if (cpsTestArea) cpsTestArea.classList.remove('hidden');
            if (cpsResultsSummary) cpsResultsSummary.classList.add('hidden');

            if (clickArea) {
                clickArea.removeEventListener('mousedown', handleCPSClick);
                clickArea.removeEventListener('touchstart', handleCPSClick);
                clickArea.addEventListener('mousedown', handleCPSClick);
                clickArea.addEventListener('touchstart', handleCPSClick);
            }

            if (clickArea) {
                clickArea.textContent = 'START';
                clickArea.classList.remove('bg-blue-600', 'cursor-crosshair', 'active:bg-blue-700', 'bg-green-500', 'active:bg-green-600');
                clickArea.classList.add('bg-gray-700'); 
            }
            
            if (cpsTimerDisplay) cpsTimerDisplay.textContent = timeLeft.toFixed(1);
            if (cpsClickCountDisplay) cpsClickCountDisplay.textContent = clicks;
            if (cpsMessage) cpsMessage.textContent = `Click the button below to start the ${currentDuration}-second test!`;
            if (durationDisplay) durationDisplay.textContent = currentDuration;
            
            updateDurationButtons(); 
        }

        function startCPSTest() {
            if (cpsGameState !== 'IDLE') return;

            if (timerInterval) clearInterval(timerInterval);
            
            cpsGameState = 'PLAYING';
            timeLeft = currentDuration;
            
            clickArea.textContent = 'CLICK! CLICK! CLICK!';
            clickArea.classList.remove('bg-gray-700');
            clickArea.classList.add('bg-blue-600', 'cursor-crosshair', 'active:bg-blue-700');
            
            cpsMessage.textContent = 'Test in progress... Click as fast as you can!';
            cpsTimerDisplay.textContent = timeLeft.toFixed(1);

            const startTime = Date.now();
            
            timerInterval = setInterval(() => {
                const elapsed = (Date.now() - startTime) / 1000;
                timeLeft = currentDuration - elapsed;
                
                if (timeLeft <= 0) {
                    endCPSTest(true); 
                } else {
                    cpsTimerDisplay.textContent = timeLeft.toFixed(1);
                }
            }, 100);
        }

        function endCPSTest(completed) {
            clearInterval(timerInterval);
            
            if (completed) {
                const finalCPS = clicks / currentDuration;
                const finalKMPH = finalCPS * 2;
                
                cpsGameState = 'IDLE'; 
                
                if (cpsTestArea) cpsTestArea.classList.add('hidden');
                if (cpsResultsSummary) cpsResultsSummary.classList.remove('hidden');

                if (finalCPSScore) finalCPSScore.textContent = finalCPS.toFixed(2);
                if (finalKMPHScore) finalKMPHScore.textContent = finalKMPH.toFixed(2);
                if (finalTotalClicks) finalTotalClicks.textContent = clicks;
                if (finalDurationDisplay) finalDurationDisplay.textContent = currentDuration;

            } else {
                 cpsGameState = 'IDLE';
                 resetCPSTester();
            }
        }

        function handleCPSClick(event) {
            event.preventDefault();
            
            if (cpsGameState === 'IDLE') {
                startCPSTest();
                clicks++; 
                if (cpsClickCountDisplay) cpsClickCountDisplay.textContent = clicks;

            } else if (cpsGameState === 'PLAYING') {
                clicks++;
                if (cpsClickCountDisplay) cpsClickCountDisplay.textContent = clicks;
            }
        }
        
        document.addEventListener('mousedown', (e) => {
            if (e.target.id === 'click-area' && cpsGameState === 'PLAYING') {
                e.preventDefault();
            }
        });

        // --- Reaction Tester Logic (Unchanged) ---
        let reactionState = 'IDLE'; 
        let timeoutId = null; 
        let startTime = null; 
        let reactionTimes = []; 
        
        const reactionClickArea = document.getElementById('reaction-click-area');
        const reactionStatusText = document.getElementById('reaction-status-text');
        const reactionResultDisplay = document.getElementById('reaction-result-display');
        const reactionTimeScore = document.getElementById('reaction-time-score');
        const reactionAverageScore = document.getElementById('reaction-average-score');
        const reactionRankDisplay = document.getElementById('reaction-rank');
        
        function getReactionRank(time) {
            if (time < 100) {
                return 'üèéÔ∏è F1 Racer üèÜ';
            } else if (time <= 150) {
                return 'üåå Ultra Instinct üöÄ';
            } else if (time <= 250) {
                return 'ü•ä Fighter üí™';
            } else if (time <= 400) {
                return 'üßç Average';
            } else {
                return 'üîÑ Try Again';
            }
        }

        function resetReactionTester() {
            clearTimeout(timeoutId);
            reactionState = 'IDLE';
            startTime = null;
            
            reactionClickArea.classList.remove('bg-green-500', 'bg-red-500', 'bg-blue-500', 'hover:bg-green-600');
            reactionClickArea.classList.add('bg-gray-500');
            
            reactionResultDisplay.classList.add('hidden');
            reactionStatusText.innerHTML = '<p class="text-2xl font-bold mb-2">Click anywhere to start.</p><p class="text-sm opacity-80">Wait for the screen to turn <span class="text-green-300 font-extrabold">GREEN</span>.</p>';
            
            reactionRankDisplay.textContent = ''; 
            updateReactionAverage();
        }

        function updateReactionAverage() {
            if (reactionTimes.length > 0) {
                const total = reactionTimes.reduce((a, b) => a + b, 0);
                const average = total / reactionTimes.length;
                reactionAverageScore.textContent = `Average of ${reactionTimes.length} runs: ${Math.round(average)} ms`;
            } else {
                reactionAverageScore.textContent = 'Average of 0 runs: 0 ms';
            }
        }

        function startReactionWaiting() {
            reactionState = 'WAITING';
            reactionResultDisplay.classList.add('hidden');
            reactionClickArea.classList.remove('bg-gray-500', 'bg-green-500', 'bg-red-500', 'bg-blue-500', 'hover:bg-green-600');
            reactionClickArea.classList.add('bg-indigo-600');
            reactionStatusText.innerHTML = '<p class="text-2xl font-bold text-white">...Wait for Green...</p>';

            const randomDelay = Math.random() * 3000 + 2000;
            
            timeoutId = setTimeout(showReactionReady, randomDelay);
        }

        function showReactionReady() {
            reactionState = 'READY';
            startTime = Date.now();
            
            reactionClickArea.classList.remove('bg-indigo-600');
            reactionClickArea.classList.add('bg-green-500', 'hover:bg-green-600');
            reactionStatusText.innerHTML = '<p class="text-4xl font-extrabold text-white">CLICK NOW!</p>';
        }

        function handleReactionClick(event) {
            event.preventDefault();

            if (reactionState === 'IDLE') {
                startReactionWaiting();
            } else if (reactionState === 'WAITING') {
                clearTimeout(timeoutId);
                reactionState = 'RESULT';
                
                reactionClickArea.classList.remove('bg-indigo-600');
                reactionClickArea.classList.add('bg-red-500');
                
                reactionStatusText.innerHTML = '<p class="text-3xl font-bold text-white">TOO SOON!</p><p class="mt-2 text-xl text-white">You clicked before it turned green.</p>';
                
                reactionTimeScore.textContent = 'Failed';
                reactionRankDisplay.textContent = '‚ùå Failed Test';
                reactionAverageScore.textContent = 'Click too soon penalty';
                reactionResultDisplay.classList.remove('hidden');

            } else if (reactionState === 'READY') {
                const endTime = Date.now();
                const reactionTime = endTime - startTime;
                
                reactionState = 'RESULT';
                reactionTimes.push(reactionTime);

                const rank = getReactionRank(reactionTime);

                reactionClickArea.classList.remove('bg-green-500', 'hover:bg-green-600');
                reactionClickArea.classList.add('bg-blue-500');

                reactionStatusText.innerHTML = '<p class="text-3xl font-bold text-white">Got it!</p><p class="mt-2 text-xl text-white">Your result is below.</p>';

                reactionTimeScore.textContent = `${reactionTime} ms`;
                reactionRankDisplay.textContent = rank;
                reactionResultDisplay.classList.remove('hidden');

                updateReactionAverage();
                
            } else if (reactionState === 'RESULT') {
                startReactionWaiting();
            }
        }
        
        if (reactionClickArea) {
            reactionClickArea.addEventListener('mousedown', (e) => {
                 if (reactionState !== 'RESULT') {
                    e.preventDefault(); 
                    handleReactionClick(e);
                 }
            });
            reactionClickArea.addEventListener('touchstart', (e) => {
                 if (reactionState !== 'RESULT') {
                    e.preventDefault(); 
                    handleReactionClick(e);
                 }
            });
        }
        
        // --- Sound Toggle Logic (Menu) ---
        (function initSoundToggle() {
            const soundToggle = document.getElementById('sound-toggle');
            const backgroundVideo = document.getElementById('background-video');
            
            function toggleSound() {
                if (backgroundVideo.muted) {
                    backgroundVideo.muted = false;
                    soundToggle.classList.remove('muted');
                    soundToggle.setAttribute('aria-label', 'Mute Sound');
                } else {
                    backgroundVideo.muted = true;
                    soundToggle.classList.add('muted');
                    soundToggle.setAttribute('aria-label', 'Unmute Sound');
                }
            }
            
            if (soundToggle && backgroundVideo) {
                soundToggle.addEventListener('click', function(e) {
                    e.preventDefault();
                    toggleSound();
                });
                
                soundToggle.addEventListener('touchstart', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    toggleSound();
                }, { passive: false });
            }
        })();

        // --- Sound Toggle Logic (Practice Mode) ---
        (function initPracticeSoundToggle() {
            const practiceToggle = document.getElementById('practice-sound-toggle');
            const practiceVideo = document.getElementById('practice-video');
            
            function togglePracticeSound() {
                if (practiceVideo.muted) {
                    practiceVideo.muted = false;
                    practiceToggle.classList.remove('muted');
                    practiceToggle.setAttribute('aria-label', 'Mute Sound');
                } else {
                    practiceVideo.muted = true;
                    practiceToggle.classList.add('muted');
                    practiceToggle.setAttribute('aria-label', 'Unmute Sound');
                }
            }
            
            if (practiceToggle && practiceVideo) {
                practiceToggle.addEventListener('click', function(e) {
                    e.preventDefault();
                    togglePracticeSound();
                });
                
                practiceToggle.addEventListener('touchstart', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    togglePracticeSound();
                }, { passive: false });
            }
        })();

        // --- Mobile Touch Controls (Consolidated from mobile-touch.js) ---
        (function () {
            const ALLOWED_MODES = ['grid', 'practice'];
            function isTouchDevice() {
                return ('ontouchstart' in window) || navigator.maxTouchPoints > 0 || navigator.msMaxTouchPoints > 0;
            }
            function currentModeIsAllowed() {
                try {
                    const mode = window.game && (window.game.mode || window.game.currentMode || window.game.getMode && window.game.getMode());
                    if (!mode) return false;
                    return ALLOWED_MODES.includes(String(mode).toLowerCase());
                } catch (e) { return false; }
            }
            function initMobileUI() {
                const hud = document.getElementById('mobile-hud');
                if (!hud) return;
                if (!isTouchDevice() || !currentModeIsAllowed()) {
                    hud.style.display = 'none';
                    hud.setAttribute('aria-hidden', 'true');
                    return;
                }
                hud.style.display = '';
                hud.setAttribute('aria-hidden', 'false');
                if (window.game && window.game.isPlaying) {
                    hud.classList.add('playing');
                } else {
                    hud.classList.remove('playing');
                }
                hookButtons();
                startHudUpdater();
            }
            function makeButton(id, eventName) {
                const el = document.getElementById(id);
                if (!el) return;
                let active = false;
                const start = (e) => { if (e && e.preventDefault) e.preventDefault(); if (active) return; active = true; window.dispatchEvent(new CustomEvent(eventName + '-start')); el.classList.add('active'); };
                const end = (e) => { if (!active) return; active = false; window.dispatchEvent(new CustomEvent(eventName + '-end')); el.classList.remove('active'); };
                el.addEventListener('touchstart', start, {passive:false});
                el.addEventListener('mousedown', start);
                ['touchend','touchcancel','mouseup','mouseleave'].forEach(evt => el.addEventListener(evt, end));
            }
            function hookButtons() {
                makeButton('btn-left', 'mobile-left');
                makeButton('btn-right', 'mobile-right');
                makeButton('btn-boost', 'mobile-boost');
                makeButton('btn-jump', 'mobile-jump');
                window.addEventListener('mobile-left-start', () => { if (window.game && window.game.input) window.game.input.set && window.game.input.set('left', true); });
                window.addEventListener('mobile-left-end', () => { if (window.game && window.game.input) window.game.input.set && window.game.input.set('left', false); });
                window.addEventListener('mobile-right-start', () => { if (window.game && window.game.input) window.game.input.set && window.game.input.set('right', true); });
                window.addEventListener('mobile-right-end', () => { if (window.game && window.game.input) window.game.input.set && window.game.input.set('right', false); });
                window.addEventListener('mobile-boost-start', () => { if (window.game && window.game.input) window.game.input.set && window.game.input.set('boost', true); });
                window.addEventListener('mobile-boost-end', () => { if (window.game && window.game.input) window.game.input.set && window.game.input.set('boost', false); });
                window.addEventListener('mobile-jump-start', () => { if (window.game && window.game.input) window.game.input.set && window.game.input.set('jump', true); });
                window.addEventListener('mobile-jump-end', () => { if (window.game && window.game.input) window.game.input.set && window.game.input.set('jump', false); });
            }
            let hudInterval = null;
            function startHudUpdater() {
                if (hudInterval) return;
                hudInterval = setInterval(() => {
                    try {
                        const scoreEl = document.getElementById('hud-score-val');
                        const lapEl = document.getElementById('hud-lap-val');
                        const posEl = document.getElementById('hud-pos');
                        if (window.game) {
                            if (scoreEl && (window.game.score !== undefined)) scoreEl.textContent = window.game.score;
                            if (lapEl && (window.game.lap !== undefined)) lapEl.textContent = window.game.lap;
                            if (posEl && (window.game.position !== undefined)) posEl.textContent = window.game.positionLabel || window.game.position;
                        }
                    } catch (e) { }
                }, 150);
            }
            function stopHudUpdater() {
                if (hudInterval) { clearInterval(hudInterval); hudInterval = null; }
            }
            window.addEventListener('load', initMobileUI);
            window.addEventListener('resize', initMobileUI);
            window.addEventListener('orientationchange', initMobileUI);
            window.addEventListener('focus', initMobileUI);
            window.addEventListener('game-mode-changed', initMobileUI);
            window.MobileUI = {
                init: initMobileUI,
                stop: () => { stopHudUpdater(); const hud = document.getElementById('mobile-hud'); if (hud) { hud.style.display = 'none'; hud.setAttribute('aria-hidden', 'true'); } }
            };
            initMobileUI();
        })();

        // --- Online Game Module (WebSocket Multiplayer) ---
        const OnlineGame = {
            // Connection State
            ws: null,
            playerId: null,
            username: '',
            carId: 'AE86',
            lobbyCode: null,
            isHost: false,
            lobby: null,
            
            // Game State
            GRID_ROWS: 5,
            GRID_HEIGHT_PERCENT: 20,
            currentLane: 2,
            score: 0,
            isGameOver: false,
            gameStartTime: null,
            elapsedTime: 0,
            timerInterval: null,
            traps: [],
            trapSeed: null,
            rng: null,
            playerHasMoved: false,
            engineIdleInterval: null,
            
            // DOM Elements
            elements: {},
            
            // Initialize WebSocket connection
            connect() {
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                // Use Replit backend for multiplayer
                const backendHost = '55d6c138-b8db-46d6-9bd2-41fc43680c39-00-3tdo2vxkwip42.sisko.replit.dev';
                const wsUrl = `${protocol}//${backendHost}/ws`;
                
                this.ws = new WebSocket(wsUrl);
                
                this.ws.onopen = () => {
                    console.log('WebSocket connected');
                    if (this.username) {
                        this.register();
                    }
                };
                
                this.ws.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    this.handleMessage(data);
                };
                
                this.ws.onclose = () => {
                    console.log('WebSocket disconnected');
                    setTimeout(() => {
                        if (this.username) {
                            this.connect();
                        }
                    }, 3000);
                };
                
                this.ws.onerror = (error) => {
                    console.error('WebSocket error:', error);
                };
            },
            
            // Send message to server
            send(message) {
                if (this.ws && this.ws.readyState === WebSocket.OPEN) {
                    this.ws.send(JSON.stringify(message));
                }
            },
            
            // Register player with server
            register() {
                this.send({
                    type: 'register',
                    username: this.username,
                    player_id: this.playerId,
                    car_id: this.carId
                });
            },
            
            // Handle incoming messages
            handleMessage(data) {
                switch (data.type) {
                    case 'registered':
                        this.playerId = data.player_id;
                        break;
                        
                    case 'lobby_created':
                        this.lobby = data.lobby;
                        this.lobbyCode = data.lobby.code;
                        this.isHost = true;
                        this.showLobbyView();
                        break;
                        
                    case 'lobby_joined':
                        this.lobby = data.lobby;
                        this.lobbyCode = data.lobby.code;
                        this.isHost = this.lobby.host_id === this.playerId;
                        this.showLobbyView();
                        break;
                        
                    case 'player_joined':
                    case 'player_left':
                    case 'player_updated':
                    case 'lobby_updated':
                        this.lobby = data.lobby;
                        this.updateLobbyDisplay();
                        break;
                        
                    case 'error':
                        this.showError(data.message);
                        break;
                        
                    case 'lobby_left':
                        this.lobby = null;
                        this.lobbyCode = null;
                        this.isHost = false;
                        this.showSelectionView();
                        break;
                        
                    case 'race_starting':
                        this.trapSeed = data.trap_seed;
                        this.startCountdown(data.countdown);
                        break;
                        
                    case 'player_state_update':
                        this.updateOtherPlayerState(data);
                        break;
                        
                    case 'player_crashed':
                        this.handlePlayerCrashed(data);
                        break;
                        
                    case 'race_finished':
                        this.showLeaderboard(data.leaderboard);
                        break;
                }
            },
            
            // UI Navigation
            submitUsername() {
                const input = document.getElementById('username-input');
                const username = input.value.trim();
                
                if (username.length < 1) {
                    alert('Please enter a username');
                    return;
                }
                
                this.username = username;
                document.getElementById('display-username').textContent = username;
                
                // Connect to WebSocket if not already connected
                if (!this.ws || this.ws.readyState !== WebSocket.OPEN) {
                    this.connect();
                } else {
                    this.register();
                }
                
                this.showSelectionView();
            },
            
            backToUsername() {
                this.hideAllViews();
                document.getElementById('online-username-view').classList.remove('hidden');
            },
            
            showSelectionView() {
                this.hideAllViews();
                document.getElementById('online-selection-view').classList.remove('hidden');
                this.updateCarSelection();
            },
            
            showJoinView() {
                this.hideAllViews();
                document.getElementById('online-join-view').classList.remove('hidden');
                document.getElementById('join-error-message').classList.add('hidden');
            },
            
            showLobbyView() {
                this.hideAllViews();
                document.getElementById('online-lobby-view').classList.remove('hidden');
                this.updateLobbyDisplay();
            },
            
            hideAllViews() {
                const views = [
                    'online-username-view',
                    'online-selection-view',
                    'online-join-view',
                    'online-lobby-view',
                    'online-countdown-view',
                    'online-racing-view',
                    'online-leaderboard-view'
                ];
                views.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.classList.add('hidden');
                });
            },
            
            // Car Selection
            selectCar(carId) {
                this.carId = carId;
                this.updateCarSelection();
                
                if (this.ws && this.ws.readyState === WebSocket.OPEN) {
                    this.send({ type: 'update_car', car_id: carId });
                }
            },
            
            updateCarSelection() {
                document.querySelectorAll('.online-car-btn').forEach(btn => {
                    btn.classList.remove('border-green-500', 'bg-green-50');
                    btn.classList.add('border-gray-300');
                });
                const selected = document.getElementById(`online-car-${this.carId}`);
                if (selected) {
                    selected.classList.remove('border-gray-300');
                    selected.classList.add('border-green-500', 'bg-green-50');
                }
            },
            
            // Lobby Actions
            hostRace() {
                if (!this.ws || this.ws.readyState !== WebSocket.OPEN) {
                    this.connect();
                    setTimeout(() => this.send({ type: 'create_lobby' }), 500);
                } else {
                    this.send({ type: 'create_lobby' });
                }
            },
            
            joinRace() {
                const code = document.getElementById('lobby-code-input').value.trim().toUpperCase();
                
                if (code.length !== 6) {
                    this.showError('Please enter a valid 6-character code');
                    return;
                }
                
                if (!this.ws || this.ws.readyState !== WebSocket.OPEN) {
                    this.connect();
                    setTimeout(() => this.send({ type: 'join_lobby', code: code }), 500);
                } else {
                    this.send({ type: 'join_lobby', code: code });
                }
            },
            
            leaveLobby() {
                this.send({ type: 'leave_lobby' });
                this.lobby = null;
                this.lobbyCode = null;
                this.isHost = false;
                this.showSelectionView();
            },
            
            copyLobbyCode() {
                if (this.lobbyCode) {
                    navigator.clipboard.writeText(this.lobbyCode).then(() => {
                        alert('Lobby code copied!');
                    });
                }
            },
            
            startRace() {
                if (!this.isHost) return;
                this.send({ type: 'start_race' });
            },
            
            returnToLobby() {
                this.send({ type: 'return_to_lobby' });
                this.showLobbyView();
            },
            
            // Display Updates
            updateLobbyDisplay() {
                if (!this.lobby) return;
                
                document.getElementById('lobby-code-display').textContent = this.lobby.code;
                document.getElementById('player-count').textContent = this.lobby.players.length;
                
                // Update host status
                const hostBadge = document.getElementById('host-badge');
                const hostControls = document.getElementById('host-controls');
                const waitingMessage = document.getElementById('waiting-message');
                
                this.isHost = this.lobby.host_id === this.playerId;
                
                if (this.isHost) {
                    hostBadge.classList.remove('hidden');
                    hostControls.classList.remove('hidden');
                    waitingMessage.classList.add('hidden');
                } else {
                    hostBadge.classList.add('hidden');
                    hostControls.classList.add('hidden');
                    waitingMessage.classList.remove('hidden');
                }
                
                // Update player list
                const playerList = document.getElementById('player-list');
                playerList.innerHTML = this.lobby.players.map(p => {
                    const isCurrentPlayer = p.player_id === this.playerId;
                    const isHostPlayer = p.player_id === this.lobby.host_id;
                    return `
                        <div class="flex items-center justify-between p-2 ${isCurrentPlayer ? 'bg-green-100' : 'bg-white'} rounded-lg mb-2">
                            <div class="flex items-center">
                                <span class="text-lg mr-2">${this.getCarEmoji(p.car_id)}</span>
                                <span class="font-medium ${isCurrentPlayer ? 'text-green-700' : 'text-gray-700'}">${p.username}</span>
                                ${isCurrentPlayer ? '<span class="ml-2 text-xs text-green-600">(You)</span>' : ''}
                            </div>
                            ${isHostPlayer ? '<span class="text-xs bg-yellow-200 text-yellow-800 px-2 py-1 rounded">Host</span>' : ''}
                        </div>
                    `;
                }).join('');
            },
            
            getCarEmoji(carId) {
                const emojis = { 'AE86': 'üöó', 'GTR': 'üèéÔ∏è', 'BRZ': 'üöô' };
                return emojis[carId] || 'üöó';
            },
            
            showError(message) {
                const errorEl = document.getElementById('join-error-message');
                if (errorEl) {
                    errorEl.textContent = message;
                    errorEl.classList.remove('hidden');
                } else {
                    alert(message);
                }
            },
            
            // Countdown & Race Start
            startCountdown(seconds) {
                this.hideAllViews();
                document.getElementById('online-countdown-view').classList.remove('hidden');
                
                const countdownEl = document.getElementById('countdown-number');
                let count = seconds;
                
                const countdownInterval = setInterval(() => {
                    countdownEl.textContent = count;
                    count--;
                    
                    if (count < 0) {
                        clearInterval(countdownInterval);
                        this.initRace();
                    }
                }, 1000);
            },
            
            // Seeded Random Number Generator
            seededRandom() {
                if (!this.rng) {
                    this.rng = this.trapSeed || 12345;
                }
                this.rng = (this.rng * 1103515245 + 12345) & 0x7fffffff;
                return this.rng / 0x7fffffff;
            },
            
            // Sound state for online mode
            accSoundTimeout: null,
            idleTimeout: null,
            lastMoveTime: 0,
            isAccSoundPlaying: false,
            crashSoundTimeout: null,
            crashAudioNodes: [],
            
            // Initialize Race
            initRace() {
                this.hideAllViews();
                document.getElementById('online-racing-view').classList.remove('hidden');
                
                // Reset sound state
                this.isAccSoundPlaying = false;
                this.lastMoveTime = 0;
                this.stopAllSounds();
                
                // Play engine start sound (loops until first move)
                this.playEngineStart();
                
                // Reset game state
                this.currentLane = 2;
                this.score = 0;
                this.isGameOver = false;
                this.elapsedTime = 0;
                this.traps = [];
                this.rng = this.trapSeed;
                this.playerHasMoved = false;
                
                // Get DOM elements
                this.elements = {
                    car: document.getElementById('online-game-car'),
                    track: document.getElementById('online-game-track'),
                    trapContainer: document.getElementById('online-trap-container'),
                    scoreDisplay: document.getElementById('online-score-display'),
                    timerDisplay: document.getElementById('online-timer-display'),
                    aliveDisplay: document.getElementById('online-alive-display'),
                    playersStatus: document.getElementById('online-players-status'),
                    gameOverMessage: document.getElementById('online-game-over-message'),
                    crashStats: document.getElementById('online-crash-stats')
                };
                
                // Set car SVG
                if (carData[this.carId] && carData[this.carId].svg) {
                    this.elements.car.innerHTML = carData[this.carId].svg;
                }
                
                // Setup event listeners
                this.boundHandleKey = this.handleKey.bind(this);
                this.boundHandleClick = this.handleClick.bind(this);
                document.addEventListener('keydown', this.boundHandleKey);
                this.elements.track.addEventListener('mousedown', this.boundHandleClick);
                this.elements.track.addEventListener('touchstart', this.boundHandleClick);
                
                // Start timer
                this.gameStartTime = Date.now();
                this.timerInterval = setInterval(() => {
                    if (!this.isGameOver) {
                        this.elapsedTime = Math.floor((Date.now() - this.gameStartTime) / 1000);
                        this.elements.timerDisplay.textContent = this.elapsedTime + 's';
                    }
                }, 100);
                
                // Initialize display
                this.elements.gameOverMessage.style.display = 'none';
                this.updateDisplay();
                this.updatePlayersStatus();
                this.render();
                
                // Spawn initial traps
                this.spawnTraps(4);
                
                // Notify server race started
                this.send({ type: 'race_started' });
            },
            
            // Handle keyboard input
            handleKey(e) {
                if (this.isGameOver) return;
                const key = e.key.toLowerCase();
                
                if (key === 'w') {
                    e.preventDefault();
                    this.changeLaneAndStep(-1);
                } else if (key === 's') {
                    e.preventDefault();
                    this.changeLaneAndStep(1);
                }
            },
            
            handleClick(e) {
                if (this.isGameOver) return;
                if (e.target.id === 'online-game-track' || e.target.id === 'online-trap-container') {
                    e.preventDefault();
                    this.changeLaneAndStep(0);
                }
            },
            
            moveUp() {
                if (!this.isGameOver) this.changeLaneAndStep(-1);
            },
            
            moveDown() {
                if (!this.isGameOver) this.changeLaneAndStep(1);
            },
            
            stepForward() {
                if (!this.isGameOver) this.changeLaneAndStep(0);
            },
            
            lastMovementTime: 0,
            
            changeLaneAndStep(direction) {
                if (this.isGameOver) return;
                
                // On first move: stop engine start sound
                if (!this.playerHasMoved) {
                    this.playerHasMoved = true;
                    this.stopEngineStart();
                }
                
                // Stop idle sound when moving again (sounds play sequentially)
                this.stopIdleSound();
                
                // Debounce: prevent multiple movements in quick succession (fix for double movement)
                const now = Date.now();
                if (now - this.lastMovementTime < 50) return;
                this.lastMovementTime = now;
                
                // Play car-specific acceleration sound
                this.playCarAccSound();
                this.lastMoveTime = Date.now();
                
                // Change lane
                if (direction !== 0) {
                    const newLane = this.currentLane + direction;
                    if (newLane >= 0 && newLane < this.GRID_ROWS) {
                        this.currentLane = newLane;
                    }
                }
                
                // Check collision before moving
                const collisionTrap = this.traps.find(trap => 
                    trap.forwardSteps === 0 && trap.lane === this.currentLane
                );
                
                if (collisionTrap) {
                    this.gameOver();
                    return;
                }
                
                // Move traps
                this.traps = this.traps.map(trap => ({
                    ...trap,
                    forwardSteps: trap.forwardSteps - 1
                })).filter(trap => trap.forwardSteps >= -1);
                
                // Update score
                this.score++;
                this.updateDisplay();
                
                // Spawn new traps every 10 points
                if (this.score % 10 === 0 && this.score > 0) {
                    this.spawnTraps(4);
                }
                
                // Render
                this.render();
                
                // Send state update to server
                this.send({
                    type: 'player_state',
                    lane: this.currentLane,
                    grids: this.score,
                    time_ms: Date.now() - this.gameStartTime
                });
            },
            
            getCarAccSoundId() {
                switch(this.carId) {
                    case 'AE86': return 'toyota-acc-sound';
                    case 'GTR': return 'nissan-acc-sound';
                    case 'BRZ': return 'subaru-acc-sound';
                    default: return 'toyota-acc-sound';
                }
            },
            
            playCarAccSound() {
                try {
                    const soundId = this.getCarAccSoundId();
                    const sound = document.getElementById(soundId);
                    if (!sound) return;
                    
                    // If already playing, just extend the timeout
                    if (this.isAccSoundPlaying) {
                        if (this.accSoundTimeout) clearTimeout(this.accSoundTimeout);
                        this.accSoundTimeout = setTimeout(() => {
                            sound.pause();
                            sound.currentTime = 0;
                            this.isAccSoundPlaying = false;
                            this.checkForIdle();
                        }, 3000);
                        return;
                    }
                    
                    // Start playing
                    sound.currentTime = 0;
                    sound.play().catch(() => {});
                    this.isAccSoundPlaying = true;
                    
                    // Stop after 3 seconds
                    if (this.accSoundTimeout) clearTimeout(this.accSoundTimeout);
                    this.accSoundTimeout = setTimeout(() => {
                        sound.pause();
                        sound.currentTime = 0;
                        this.isAccSoundPlaying = false;
                        this.checkForIdle();
                    }, 3000);
                } catch (e) {}
            },
            
            stopCarAccSound() {
                try {
                    if (this.accSoundTimeout) {
                        clearTimeout(this.accSoundTimeout);
                        this.accSoundTimeout = null;
                    }
                    ['toyota-acc-sound', 'nissan-acc-sound', 'subaru-acc-sound'].forEach(id => {
                        const sound = document.getElementById(id);
                        if (sound) {
                            sound.pause();
                            sound.currentTime = 0;
                        }
                    });
                    this.isAccSoundPlaying = false;
                } catch (e) {}
            },
            
            checkForIdle() {
                if (this.idleTimeout) clearTimeout(this.idleTimeout);
                if (this.isGameOver || !this.playerHasMoved) return;
                
                this.idleTimeout = setTimeout(() => {
                    if (!this.isGameOver && this.playerHasMoved && !this.isAccSoundPlaying) {
                        this.playIdleSound();
                    }
                }, 500);
            },
            
            playIdleSound() {
                try {
                    if (this.isGameOver) return;
                    const sound = document.getElementById('supra-ratatatata-sound');
                    if (sound) {
                        sound.currentTime = 0;
                        sound.play().catch(() => {});
                    }
                } catch (e) {}
            },
            
            stopIdleSound() {
                try {
                    const sound = document.getElementById('supra-ratatatata-sound');
                    if (sound) {
                        sound.pause();
                        sound.currentTime = 0;
                    }
                    if (this.idleTimeout) {
                        clearTimeout(this.idleTimeout);
                        this.idleTimeout = null;
                    }
                } catch (e) {}
            },
            
            playEngineStart() {
                try {
                    const sound = document.getElementById('engine-start-sound');
                    if (sound) {
                        sound.currentTime = 0;
                        sound.loop = true;
                        sound.play().catch(() => {});
                    }
                } catch (e) {}
            },
            
            stopEngineStart() {
                try {
                    const sound = document.getElementById('engine-start-sound');
                    if (sound) {
                        sound.pause();
                        sound.currentTime = 0;
                    }
                } catch (e) {}
            },
            
            playCrashSound() {
                try {
                    const audioContext = window.audioContext || (window.audioContext = new (window.AudioContext || window.webkitAudioContext)());
                    const now = audioContext.currentTime;
                    const duration = 60; // Exactly 1 minute
                    
                    this.crashAudioNodes = [];
                    
                    const createCrashLayer = (startTime, layerDuration) => {
                        const bufferSize = audioContext.sampleRate * layerDuration;
                        const noiseBuffer = audioContext.createBuffer(1, bufferSize, audioContext.sampleRate);
                        const noiseData = noiseBuffer.getChannelData(0);
                        
                        for (let i = 0; i < bufferSize; i++) {
                            const t = i / bufferSize;
                            const envelope = Math.exp(-t * 3) * 0.5 + Math.exp(-t * 0.5) * 0.5;
                            noiseData[i] = (Math.random() * 2 - 1) * envelope;
                        }
                        
                        const noiseSource = audioContext.createBufferSource();
                        noiseSource.buffer = noiseBuffer;
                        
                        const lowPass = audioContext.createBiquadFilter();
                        lowPass.type = 'lowpass';
                        lowPass.frequency.setValueAtTime(800, startTime);
                        lowPass.frequency.exponentialRampToValueAtTime(200, startTime + layerDuration);
                        
                        const noiseGain = audioContext.createGain();
                        noiseSource.connect(lowPass);
                        lowPass.connect(noiseGain);
                        noiseGain.connect(audioContext.destination);
                        noiseGain.gain.setValueAtTime(0.3, startTime);
                        noiseGain.gain.exponentialRampToValueAtTime(0.01, startTime + layerDuration);
                        
                        noiseSource.start(startTime);
                        noiseSource.stop(startTime + layerDuration);
                        this.crashAudioNodes.push(noiseSource);
                    };
                    
                    // Initial loud explosion
                    const boomOsc = audioContext.createOscillator();
                    const boomGain = audioContext.createGain();
                    boomOsc.connect(boomGain);
                    boomGain.connect(audioContext.destination);
                    boomOsc.type = 'sine';
                    boomOsc.frequency.setValueAtTime(150, now);
                    boomOsc.frequency.exponentialRampToValueAtTime(20, now + 2);
                    boomGain.gain.setValueAtTime(0.5, now);
                    boomGain.gain.exponentialRampToValueAtTime(0.01, now + 3);
                    boomOsc.start(now);
                    boomOsc.stop(now + 3);
                    this.crashAudioNodes.push(boomOsc);
                    
                    for (let i = 0; i < 20; i++) {
                        createCrashLayer(now + i * 3, Math.min(5, duration - i * 3));
                    }
                    
                    this.crashSoundTimeout = setTimeout(() => {
                        this.stopCrashSound();
                    }, 60000);
                    
                } catch (e) {}
            },
            
            stopCrashSound() {
                try {
                    if (this.crashSoundTimeout) {
                        clearTimeout(this.crashSoundTimeout);
                        this.crashSoundTimeout = null;
                    }
                    this.crashAudioNodes.forEach(node => {
                        try { node.stop(); } catch(e) {}
                    });
                    this.crashAudioNodes = [];
                } catch (e) {}
            },
            
            stopAllSounds() {
                this.stopEngineStart();
                this.stopCarAccSound();
                this.stopIdleSound();
                this.stopCrashSound();
            },
            
            spawnTraps(distance) {
                const existingTrapAtSpawn = this.traps.find(trap => trap.forwardSteps === distance);
                if (existingTrapAtSpawn) return;
                
                const allLanes = [0, 1, 2, 3, 4];
                let safeLanes = [];
                
                const numSafeLanes = this.seededRandom() < 0.5 ? 1 : 2;
                
                if (numSafeLanes === 1) {
                    const safeLane = Math.floor(this.seededRandom() * this.GRID_ROWS);
                    safeLanes.push(safeLane);
                } else {
                    const startingLane = Math.floor(this.seededRandom() * (this.GRID_ROWS - 1));
                    safeLanes.push(startingLane);
                    safeLanes.push(startingLane + 1);
                }
                
                const trapLanes = allLanes.filter(lane => !safeLanes.includes(lane));
                
                trapLanes.forEach(lane => {
                    this.traps.push({ lane, forwardSteps: distance });
                });
            },
            
            render() {
                // Render car position
                const topPercent = this.currentLane * this.GRID_HEIGHT_PERCENT + (this.GRID_HEIGHT_PERCENT / 2);
                this.elements.car.style.top = `${topPercent}%`;
                
                // Render traps
                this.elements.trapContainer.innerHTML = '';
                this.traps.forEach(trap => {
                    const trapElement = document.createElement('div');
                    trapElement.className = 'trap';
                    trapElement.style.position = 'absolute';
                    trapElement.style.width = '20%';
                    trapElement.style.height = '20%';
                    trapElement.style.display = 'flex';
                    trapElement.style.alignItems = 'center';
                    trapElement.style.justifyContent = 'center';
                    trapElement.style.fontSize = '2rem';
                    trapElement.style.pointerEvents = 'none';
                    trapElement.style.zIndex = '10';
                    
                    const trapTopPercent = trap.lane * this.GRID_HEIGHT_PERCENT;
                    trapElement.style.top = `${trapTopPercent}%`;
                    
                    const gridMovementRange = 75;
                    const leftPercent = 20 + (trap.forwardSteps * (gridMovementRange / 4));
                    trapElement.style.left = `${leftPercent}%`;
                    
                    if (leftPercent > 100) {
                        trapElement.style.opacity = '0';
                    }
                    
                    trapElement.textContent = 'üöß';
                    this.elements.trapContainer.appendChild(trapElement);
                });
            },
            
            updateDisplay() {
                this.elements.scoreDisplay.textContent = this.score;
            },
            
            updatePlayersStatus() {
                if (!this.lobby) return;
                
                const alivePlayers = this.lobby.players.filter(p => !p.is_crashed);
                this.elements.aliveDisplay.textContent = alivePlayers.length;
                
                this.elements.playersStatus.innerHTML = this.lobby.players.map(p => {
                    const isMe = p.player_id === this.playerId;
                    const statusColor = p.is_crashed ? 'bg-red-200 text-red-800' : 'bg-green-200 text-green-800';
                    return `<span class="text-xs px-2 py-1 rounded ${statusColor} ${isMe ? 'font-bold' : ''}">${p.username}${isMe ? ' (You)' : ''}: ${p.grids_survived}</span>`;
                }).join('');
            },
            
            updateOtherPlayerState(data) {
                if (!this.lobby) return;
                
                const player = this.lobby.players.find(p => p.player_id === data.player_id);
                if (player) {
                    player.current_lane = data.lane;
                    player.grids_survived = data.grids;
                    player.survival_time_ms = data.time_ms;
                    this.updatePlayersStatus();
                }
            },
            
            handlePlayerCrashed(data) {
                if (!this.lobby) return;
                
                const player = this.lobby.players.find(p => p.player_id === data.player_id);
                if (player) {
                    player.is_crashed = true;
                    player.grids_survived = data.grids;
                    player.survival_time_ms = data.time_ms;
                    this.updatePlayersStatus();
                }
            },
            
            gameOver() {
                this.isGameOver = true;
                
                // Stop timer
                if (this.timerInterval) {
                    clearInterval(this.timerInterval);
                }
                
                // Stop all other sounds first (sequential - one sound at a time)
                this.stopAllSounds();
                
                // Play crash sound (lasts exactly 1 minute)
                this.playCrashSound();
                
                // Remove event listeners
                document.removeEventListener('keydown', this.boundHandleKey);
                this.elements.track.removeEventListener('mousedown', this.boundHandleClick);
                this.elements.track.removeEventListener('touchstart', this.boundHandleClick);
                
                // Show game over
                this.elements.gameOverMessage.style.display = 'flex';
                this.elements.crashStats.textContent = `${this.score} Grids in ${this.elapsedTime}s`;
                
                // Notify server
                this.send({
                    type: 'player_crashed',
                    grids: this.score,
                    time_ms: Date.now() - this.gameStartTime
                });
            },
            
            showLeaderboard(leaderboard) {
                this.hideAllViews();
                document.getElementById('online-leaderboard-view').classList.remove('hidden');
                
                const container = document.getElementById('leaderboard-container');
                container.innerHTML = leaderboard.map((entry, index) => {
                    const isMe = entry.username === this.username;
                    const medalColors = ['bg-yellow-400', 'bg-gray-300', 'bg-amber-600'];
                    const medalBg = index < 3 ? medalColors[index] : 'bg-gray-200';
                    
                    return `
                        <div class="flex items-center justify-between p-3 ${isMe ? 'bg-green-100 border-2 border-green-400' : 'bg-gray-50'} rounded-lg mb-2">
                            <div class="flex items-center">
                                <span class="w-8 h-8 flex items-center justify-center ${medalBg} rounded-full font-bold text-white mr-3">${entry.rank}</span>
                                <span class="text-lg mr-2">${this.getCarEmoji(entry.car_id)}</span>
                                <span class="font-medium ${isMe ? 'text-green-700' : 'text-gray-700'}">${entry.username}</span>
                                ${isMe ? '<span class="ml-2 text-xs text-green-600">(You)</span>' : ''}
                            </div>
                            <div class="text-right">
                                <div class="font-bold text-gray-800">${entry.grids_survived} grids</div>
                                <div class="text-xs text-gray-500">${Math.floor(entry.survival_time_ms / 1000)}s</div>
                            </div>
                        </div>
                    `;
                }).join('');
            }
        };

        window.onload = function() {
            // Initialize the view to show the menu
            showPage('menu');
            updateIndicators(0);
            
            // Initial element binding for CarGame
            CarGame.car = document.getElementById('game-car');
            CarGame.track = document.getElementById('game-track');
            CarGame.trapContainer = document.getElementById('trap-container');
            CarGame.scoreDisplay = document.getElementById('current-score-display');
            CarGame.gameOverMessage = document.getElementById('game-over-message');
            CarGame.finalScoreDisplay = document.getElementById('final-game-score');
        };
    </script>

</body>
</html>
